<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>奇諾影像報價單 (RWD-V13.0.1)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        kino: { DEFAULT: '#105482', light: '#1e6fa5', dark: '#0c3e60', 50: '#f0f6fa' },
                        'kino-darker': '#31557e',
                        'kino-medium': '#4470a0',
                    }
                }
            }
        };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* V11: 通用樣式 */
        .print-container {
            background-color: white;
            font-size: 11px;
            line-height: 1.3;
            color: #000;
        }

        .print-container table { width: 100%; border-collapse: collapse; }
        .print-container th, .print-container td { border: 1px solid #000; }
        
        .print-container .table-rounded-wrapper {
            border-radius: 0.5rem; 
            overflow: hidden;
            border: 1px solid #000;
        }
        .print-container .table-rounded-wrapper table { border-style: hidden; }

        /* V12 修正: 報價單主標題降 2pt (18pt) 並確保字重 */
        .print-container h1 { font-size: 18pt; margin-bottom: 5px; font-weight: 800; }
        
        /* V12.4 修正: 大項目標題文字改為黑色 (text-black) */
        .print-container h2 { 
            font-size: 13pt; 
            margin-top: 10px; 
            margin-bottom: 5px; 
            font-weight: bold; 
            color: black; /* 修正顏色為黑色 */
            border-left: 4px solid #105482;
            padding-left: 0.5rem;
            border-bottom: none;
        }
        .print-container h3 { font-size: 12pt; }

        /* 列印特定樣式 */
        @media print {
            @page { size: A4; margin: 15mm; } 
            
            body { background-color: white; -webkit-print-color-adjust: exact; }
            
            .no-print { display: none !important; }
            .print-layer { display: block !important; }
            .screen-preview { display: none !important; }

            .page-break { page-break-before: always; }
            .avoid-break { page-break-inside: avoid; }
            
            .print-container {
                width: 100% !important;
                margin: 0 auto !important; 
                padding: 0 !important;
                box-shadow: none !important;
            }

            /* V11: 單頁列印 (70%) 修正 */
            .print-container.single-page-mode {
                zoom: 0.70; 
                margin: 0 auto !important; 
                width: 100% !important;
            }
            
            /* V11: 第六項 (詳細細項) 總是強制分頁 (需求 1) */
            .page-break.detailed-services-page-break {
                 page-break-before: always !important;
            }
            
            /* V11: 付款方式 (Section IV) 的條件分頁，在單頁模式下取消分頁 (需求 2) */
            /* 預設: page-break-conditional 帶有 page-break-before: always */
            .single-page-mode .page-break-conditional {
                page-break-before: avoid !important;
                margin-top: 5px !important; 
            }
            
            input, textarea { border: none !important; background: transparent !important; padding: 0 !important; resize: none; }
            
            .overflow-x-auto { overflow-x: visible !important; }
        }
        
        input[type="date"] { min-width: 0; appearance: none; -webkit-appearance: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const getLocalDateString = () => {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        // V13: 圖片壓縮函數 (保留 PNG 透明度)
        const compressImage = (file, quality = 0.8, maxWidth = 2048) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        try {
                            let width = img.width;
                            let height = img.height;

                            // 限制最大寬度
                            if (width > maxWidth) {
                                height = Math.round((height * maxWidth) / width);
                                width = maxWidth;
                            }
                            
                            const canvas = document.createElement('canvas');
                            canvas.width = width;
                            canvas.height = height;
                            
                            const ctx = canvas.getContext('2d');
                            
                            // 設置背景為透明 (關鍵：保留 PNG/GIF 透明度)
                            if (file.type === 'image/png' || file.type === 'image/gif') {
                                ctx.clearRect(0, 0, width, height); 
                            }
                            ctx.drawImage(img, 0, 0, width, height);

                            let mimeType = file.type;
                            let compressedBase64;

                            if (mimeType === 'image/png' || mimeType === 'image/gif') {
                                // PNG/GIF: 保持原始格式輸出，保留透明度
                                compressedBase64 = canvas.toDataURL(mimeType);
                            } else {
                                // JPEG/其他: 使用質量壓縮
                                compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                            }

                            resolve(compressedBase64);
                        } catch (e) {
                            reject(e);
                        }
                    };
                    img.onerror = reject;
                    img.src = event.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        };


        const defaultNotes = [
            "甲方委託乙方於2025年12月1日拍攝形象影片，成品交付影片乙支，拍攝期間甲方應於現場確認畫面無虞，製作費包含乙方 ■ 技術人員、 □ 演員、 □ 場地、 ■ 器材等相關費用，專案期間或結案後，甲方對於本專案內容倘有除合約議定外額外製作/修改需求，為本案預算不可及之部分，經雙方協議後，由乙方針對甲方需求另行報價。",
            "影片經後期輸出後，內容若有須修改事項，甲方得於每次收件 7 日內要求乙方修正，次數 2 次為限。",
            "乙方擔保就其提供甲方利用之影片內容，除由甲方提供或要求外，具有合法智慧財產權利，\n若有違反著作權之爭議相關法律責任由乙方負責。",
            "乙方應於約定交片日完成本專案並交付予甲方，甲方了解製作時程根據溝通回覆之進度而有不同差異，\n若因自然災害等不可抗力之因素或甲方要求致無法遵守進度時，雙方應另議交片日或依下列第5條所示結算。",
            "如非乙方之過失而中途停止或取消本案之執行時，其已執行部份仍需計費，非經雙方同意仍應支付全額費用，甲方不得以本案尚未全部完成為理由而拒絕付款。",
            "本契約之解釋、效力及其他未盡事宜，皆以相關法律為準則。倘有任何糾紛，雙方亦應依誠實信用原則解決。如有訴訟必要，雙方同意於新北地方法院板橋簡易庭進行訴訟程序。"
        ];

        // V12.9.3: 新增付款預設方案
        const paymentPresets = {
            'default': [ // 三期 (4:3:3) - 原始預設
                { id: 1, stage: '第一期 (訂金)', percent: 40, condition: '本報價單/合約簽訂後 3 日內支付。', note: '專案正式啟動' },
                { id: 2, stage: '第二期 (拍攝款)', percent: 30, condition: '影片拍攝日結束後 3 日內支付。', note: '拍攝團隊費用' },
                { id: 3, stage: '第三期 (尾款)', percent: 30, condition: '最終成品 (Final) 交付後 7 日內支付。', note: '專案結案及剪輯費用' }
            ],
            'two_parts': [ // 兩期 (5:5)
                { id: 1, stage: '第一期 (訂金)', percent: 50, condition: '本報價單/合約簽訂後 3 日內支付。', note: '專案正式啟動' },
                { id: 2, stage: '第二期 (尾款)', percent: 50, condition: '最終成品 (Final) 交付後 7 日內支付。', note: '專案結案及剪輯費用' }
            ],
            'full_payment_upfront': [ // 一期 (全款 - 簽訂後支付)
                { id: 1, stage: '第一期 (全款)', percent: 100, condition: '本報價單/合約簽訂後 3 日內支付。', note: '專案正式啟動' }
            ],
            'full_payment_upon_completion': [ // 一期 (全款 - 交付後支付)
                { id: 1, stage: '第一期 (全款)', percent: 100, condition: '最終成品 (Final) 交付後 7 日內支付。', note: '專案結案及剪輯費用' }
            ],
        };

        const defaultData = {
            header: { id: '', date: getLocalDateString(), valid: '14天' },
            projectFields: [
                { id: 'p1', label: '專案名稱', value: '形象影片' },
                { id: 'p2', label: '專案類型', value: '影片統籌製作' },
                { id: 'p3', label: '片長預估', value: '約2分鐘' },
                { id: 'p4', label: '交付格式', value: 'Full HD' },
            ],
            categories: [
                { id: 1, name: 'I. Pre-production Expenses / 前期', items: [
                    { id: 1, desc: '前期企劃與腳本撰寫（含 2 次修改）', unit: '式', qty: 1, price: 0 },
                    { id: 2, desc: '場地租賃或勘景費用', unit: '式', qty: 1, price: 0 }
                ] },
                { id: 2, name: 'II. Production Crew Expenses / 拍攝', items: [
                    { id: 1, desc: '導演（含現場指導與後期監製）', unit: '天', qty: 1, price: 0 },
                    { id: 2, desc: '攝影組（影像構圖及視覺呈現）', unit: '天', qty: 1, price: 0 },
                    { id: 3, desc: '燈光組（塑造場景畫面氛圍）', unit: '天', qty: 1, price: 0 },
                    { id: 4, desc: '造型師（包含 3 位演員）', unit: '天', qty: 1, price: 0 }
                ] },
                { id: 3, name: 'III. Equipment Rental / 器材', items: [
                    { id: 1, desc: '全幅攝影機租賃（Sony FX3 或同級）', unit: '天', qty: 1, price: 0 },
                    { id: 2, desc: '進階燈光組租賃（含柔光、硬光、控光設備）', unit: '天', qty: 1, price: 0 },
                    { id: 3, desc: '高階無線收音設備（24-bit 浮點錄音）', unit: '天', qty: 1, price: 0 }
                ] },
                { id: 4, name: 'IV. Video Post Production / 影像後期', items: [
                    { id: 1, desc: '影片剪輯（含毛片初剪、精剪，2 次修改）', unit: '式', qty: 1, price: 0 },
                    { id: 2, desc: '校色調光（一級校色還原、二級調光）', unit: '式', qty: 1, price: 0 },
                    { id: 3, desc: '視覺特效和字卡（效果字和2D動畫等）', unit: '式', qty: 1, price: 0 },
                    { id: 4, desc: '版權配樂和音效處理（商用授權）', unit: '次', qty: 1, price: 0 }
                ] },
            ],
            notes: defaultNotes,
            payment: paymentPresets.default, // 初始使用三期預設
            bank: { name: '奇諾影像有限公司', bank: '807 永豐銀行 板新分行', acc: '007-018-0005565-8' },
            signatures: {
                client: { company: '', rep: '', taxId: '', phone: '', img: '' },
                vendor: { company: '奇諾影像有限公司', rep: '陳廷安', taxId: '83115577', phone: '0911715138', img: '' },
                date: getLocalDateString() 
            },
            // V13.0.1 修正: 設定新的 LOGO 預設 Base64 字串
            logo: 'data:image/png;base64,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', 
            taxMode: 'excluded', 
        };

        const IconButton = ({ icon, onClick, color = "text-gray-500", label, className="" }) => (
            <button onClick={onClick} className={`p-2 rounded-full hover:bg-gray-100 ${color} transition ${className}`}>
                <i className={`fas ${icon}`}></i> {label && <span className="ml-1 text-sm">{label}</span>}
            </button>
        );

        const InputGroup = ({ label, value, onChange, type = "text", placeholder, className="" }) => (
            <div className={`mb-3 ${className}`}>
                <label className="block text-xs font-bold text-gray-500 mb-1">{label}</label>
                <input 
                    type={type} 
                    value={value} 
                    onChange={e => onChange(e.target.value)}
                    placeholder={placeholder}
                    className="w-full p-2 border border-gray-300 rounded-lg focus:border-kino focus:ring-1 focus:ring-kino outline-none text-gray-800 bg-white"
                />
            </div>
        );

        function App() {
            const [activeTab, setActiveTab] = useState('project'); 
            const [data, setData] = useState(defaultData);
            const [previewSettings, setPreviewSettings] = useState({
                showDetails: true,
                showSigDate: true,
                singlePageMode: false 
            });
            const [loading, setLoading] = useState(false); // V11: 增加載入狀態
            // V12.1: 拖曳排序狀態
            const [draggedItemIndex, setDraggedItemIndex] = useState(null);

            useEffect(() => {
                const saved = localStorage.getItem('kino_rwd_v10_draft');
                if (saved) {
                    try { setData(JSON.parse(saved)); } catch(e) { console.error("Error loading data from localStorage:", e); } // V11: 增加 try...catch
                }
                if (!data.header.id) updateQuotationId('形象影片', data.header.date);
            }, []); 

            useEffect(() => {
                // V13 修正: 使用 try...catch 包裹，避免 LocalStorage 配額溢出導致應用程式崩潰
                try {
                    localStorage.setItem('kino_rwd_v10_draft', JSON.stringify(data));
                } catch (error) {
                    if (error.name === 'QuotaExceededError') {
                        console.error("錯誤：本地儲存空間已滿，數據未能保存。請清除瀏覽器快取或備份文件。");
                    } else {
                        console.error("保存數據時發生錯誤:", error);
                    }
                    // 即使報錯，應用程式也不會崩潰
                }
            }, [data]);

            const updateQuotationId = (name, date) => {
                const d = date.replace(/-/g, '').slice(2);
                // V11: 移除全形標點符號，僅保留中英數
                const cleanName = (name || '').replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, '').slice(0, 5); 
                // V12.9.1 修正: 在日期和專案名稱之間加入一個空格
                setData(prev => ({...prev, header: {...prev.header, id: `${d} ${cleanName}_KS01`}}));
            };

            const updateDeep = (path, value) => {
                setData(prev => {
                    const newData = JSON.parse(JSON.stringify(prev));
                    let current = newData;
                    // V11: 使用 for 循環取代 forEach，確保 path 陣列能正確導航
                    for (let i = 0; i < path.length - 1; i++) {
                        if (current && current[path[i]] !== undefined) {
                            current = current[path[i]];
                        } else {
                            // 預防錯誤: 如果路徑不存在，則終止
                            console.error("Invalid path for deep update:", path);
                            return prev;
                        }
                    }
                    current[path[path.length - 1]] = value;
                    
                    if (path[0] === 'header' && path[1] === 'date') {
                        const foundField = newData.projectFields.find(f => f.label.includes('專案名稱'));
                        const projName = foundField ? foundField.value : '';
                        updateQuotationId(projName, value);
                    }
                    if (path[0] === 'projectFields') {
                         const foundField = newData.projectFields.find(f => f.label.includes('專案名稱'));
                         const projName = foundField ? foundField.value : '';
                         updateQuotationId(projName, newData.header.date);
                    }
                    return newData;
                });
            };
            
            // V12.1: 拖曳排序邏輯
            const handleDragStart = (e, index) => {
                // V12.4 修正: 確保在行動裝置上拖曳時，不會觸發文本選取
                e.dataTransfer.setData('text/plain', '');
                setDraggedItemIndex(index);
            };

            const handleDragEnter = (e, index) => {
                e.preventDefault();
                if (draggedItemIndex === null || draggedItemIndex === index) return;

                const newNotes = [...data.notes];
                const draggedItem = newNotes[draggedItemIndex];
                
                // 移除被拖曳項
                newNotes.splice(draggedItemIndex, 1);
                
                // 插入到新的位置
                newNotes.splice(index, 0, draggedItem);
                
                // 更新狀態和被拖曳項的當前索引，實現即時排序
                setData(prev => ({...prev, notes: newNotes}));
                setDraggedItemIndex(index); 
            };

            const handleDragEnd = () => {
                setDraggedItemIndex(null);
            };
            
            // V12.9.7 修正: 使用壓縮代替大小限制
            const processFileUpload = async (e, targetPath) => {
                const file = e.target.files[0];
                if(!file || !file.type.startsWith('image/')) return;

                setLoading(true);
                try {
                    // 使用壓縮函數處理圖片，壓縮質量為 0.8，最大寬度 2048 (PNG 保持原樣但縮放尺寸)
                    const compressedBase64 = await compressImage(file, 0.8, 2048);
                    updateDeep(targetPath, compressedBase64);
                } catch(error) {
                    console.error("圖片處理失敗:", error);
                    // 可以在 UI 上顯示錯誤訊息
                } finally {
                    setLoading(false);
                }
            };


            const handleLogoUpload = (e) => processFileUpload(e, ['logo']);
            const handleSigUpload = (e, party) => processFileUpload(e, ['signatures', party, 'img']);


            // V12.9.4 修正: 儲存時詢問儲存位置
            const saveFile = () => {
                if (!window.confirm('確定要儲存報價單數據嗎？這將下載一個 .json 文件。')) return;

                const jsonStr = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonStr], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                // 為了兼容性，我們仍將文件名設定為默認值，但讓瀏覽器處理路徑選擇
                a.download = `${data.header.id || 'quotation'}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url); // 釋放 blob URL
            };
            
            const loadFile = (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try { 
                        setData(JSON.parse(ev.target.result)); 
                        console.log('檔案載入成功');
                    }
                    catch(err) { 
                        console.error('檔案格式錯誤', err);
                    }
                };
                reader.readAsText(file);
            };
            
            // V12.9 新增: 分頁還原預設值功能
            const resetTab = () => {
                if (!window.confirm('確定要將目前分頁還原成預設值嗎？此操作無法復原。')) return;
                
                setData(prev => {
                    const newData = JSON.parse(JSON.stringify(prev));
                    const defaults = JSON.parse(JSON.stringify(defaultData)); // 確保取得乾淨的預設值副本

                    if (activeTab === 'project') {
                        newData.header = defaults.header;
                        // 日期保持當天，避免跳回舊資料
                        newData.header.date = getLocalDateString(); 
                        newData.projectFields = defaults.projectFields;
                        newData.signatures = defaults.signatures;
                        newData.signatures.date = getLocalDateString();
                        newData.logo = defaults.logo;
                    } else if (activeTab === 'items') {
                        newData.categories = defaults.categories;
                        newData.taxMode = defaults.taxMode;
                    } else if (activeTab === 'terms') {
                        newData.notes = defaults.notes;
                        // V12.9.3: 還原付款條件為預設三期
                        newData.payment = paymentPresets.default; 
                        newData.bank = defaults.bank;
                    }
                    return newData;
                });
            };

            // V12.9.3: 套用付款預設方案
            const applyPaymentPreset = (presetKey) => {
                if (!window.confirm('確定要套用此預設付款方案嗎？這將覆蓋現有的付款條件。')) return;
                setData(prev => ({
                    ...prev,
                    payment: paymentPresets[presetKey]
                }));
            };
            
            const totals = () => {
                let subtotal = 0;
                // V11: 確保價格和數量是數字類型
                data.categories.forEach(cat => cat.items.forEach(i => subtotal += (Number(i.price)||0)*(Number(i.qty)||0)));
                let total = subtotal;
                if(data.taxMode === 'included') total = Math.round(subtotal * 1.05);
                return total;
            };

            return (
                <div>
                    {/* V11: 載入指示器 */}
                    {loading && (
                        <div className="fixed inset-0 bg-black/30 flex items-center justify-center z-[100]">
                            <div className="bg-white p-4 rounded-lg shadow-xl flex items-center">
                                <i className="fas fa-spinner fa-spin text-kino text-xl mr-3"></i>
                                <span className="font-bold text-gray-700">圖片處理中...</span>
                            </div>
                        </div>
                    )}
                    
                    <div id="screen-ui" className="max-w-screen-md mx-auto min-h-screen bg-gray-100 sm:border-x sm:border-gray-200 relative pb-20 no-print">
                        <div className="bg-white sticky top-0 z-50 shadow-sm border-b">
                            <div className="flex justify-between items-center p-3">
                                <h1 className="font-bold text-kino text-lg truncate flex-1">
                                    {data.header.id || '報價單'}
                                </h1>
                                <div className="flex gap-2">
                                    {/* V12.9.4 修正: 儲存按鈕調用修改後的 saveFile */}
                                    <button onClick={saveFile} className="bg-gray-100 text-gray-600 px-3 py-1.5 rounded-lg text-xs"><i className="fas fa-save"></i> 儲存</button>
                                    <label className="bg-gray-100 text-gray-600 px-3 py-1.5 rounded-lg text-xs cursor-pointer flex items-center gap-1">
                                        <i className="fas fa-folder-open"></i> 開啟 <input type="file" className="hidden" onChange={loadFile} accept=".json"/>
                                    </label>
                                    {/* V12.9 新增: 還原預設按鈕 (僅在非預覽模式顯示) */}
                                    {activeTab !== 'preview' && (
                                        <button onClick={resetTab} className="bg-gray-100 text-gray-500 hover:text-red-500 px-3 py-1.5 rounded-lg text-xs transition" title="還原此頁預設值">
                                            <i className="fas fa-undo"></i>
                                        </button>
                                    )}
                                </div>
                            </div>
                            <div className="flex bg-white px-2">
                                {['project:專案', 'items:報價', 'terms:條款', 'preview:預覽'].map(tab => {
                                    const [key, label] = tab.split(':');
                                    return (
                                        <button key={key} onClick={() => setActiveTab(key)}
                                            className={`flex-1 py-3 text-sm font-bold border-b-2 transition ${activeTab===key ? 'border-kino text-kino' : 'border-transparent text-gray-400'}`}>
                                            {label}
                                        </button>
                                    )
                                })}
                            </div>
                        </div>

                        {/* Content */}
                        <div>
                            {activeTab === 'project' && (
                                <div className="space-y-4 p-4 pb-24">
                                    <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                                        <div className="flex justify-between items-start mb-2">
                                            <h3 className="font-bold text-kino"><i className="fas fa-image mr-2"></i>Logo</h3>
                                        </div>
                                        <div className="h-24 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center overflow-hidden cursor-pointer hover:border-kino transition bg-gray-50 relative"
                                             onClick={() => document.getElementById('upload-logo').click()}>
                                            {/* V12.9.7: 綁定到 processFileUpload */}
                                            <input type="file" id="upload-logo" className="hidden" accept="image/*" onChange={handleLogoUpload} disabled={loading}/> 
                                            {loading ? ( 
                                                <div className="text-kino text-sm flex flex-col items-center"><i className="fas fa-spinner fa-spin text-2xl mb-1"></i>載入中</div>
                                            ) : data.logo ? 
                                                <img src={data.logo} className="h-full object-contain p-2" onError={(e) => { e.target.onerror = null; e.target.src = "https://placehold.co/100x24/f0f6fa/6b7280?text=圖片載入失敗"; }}/> : 
                                                <div className="text-gray-400 text-xs flex flex-col items-center"><i className="fas fa-cloud-upload-alt text-2xl mb-1"></i>點擊上傳圖片</div>
                                            }
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-x-4 mt-4">
                                            <InputGroup label="報價單號" value={data.header.id} onChange={v => updateDeep(['header', 'id'], v)} />
                                            <InputGroup label="報價日期" value={data.header.date} type="date" onChange={v => updateDeep(['header', 'date'], v)} />
                                            <InputGroup label="有效期限" value={data.header.valid} onChange={v => updateDeep(['header', 'valid'], v)} />
                                        </div>
                                    </div>

                                    <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                                        <div className="flex justify-between items-center mb-3 border-b pb-2">
                                            <h3 className="font-bold text-kino"><i className="fas fa-briefcase mr-2"></i>專案內容</h3>
                                            <button onClick={() => setData(prev => ({...prev, projectFields: [...prev.projectFields, {id: Date.now(), label: '新欄位', value: ''}]}))} 
                                                className="text-xs bg-gray-100 px-2 py-1 rounded hover:bg-gray-200"><i className="fas fa-plus"></i></button>
                                        </div>
                                        <div className="space-y-3">
                                            {data.projectFields.map((field, idx) => (
                                                <div key={field.id} className="flex items-center gap-2">
                                                    <input className="w-1/3 text-xs font-bold text-gray-500 bg-transparent border-b border-dashed focus:outline-none"
                                                        value={field.label} onChange={(e) => {
                                                            const newFields = [...data.projectFields]; newFields[idx].label = e.target.value; setData(prev => ({...prev, projectFields: newFields}));
                                                        }} />
                                                    <input className="w-2/3 p-2 border border-gray-300 rounded-lg text-sm"
                                                        value={field.value} onChange={(e) => {
                                                            const newFields = [...data.projectFields]; newFields[idx].value = e.target.value;
                                                            if(field.label.includes('專案名稱')) updateQuotationId(e.target.value, data.header.date);
                                                            setData(prev => ({...prev, projectFields: newFields}));
                                                        }} />
                                                    <button className="text-red-300" onClick={() => setData(prev => ({...prev, projectFields: prev.projectFields.filter(f => f.id !== field.id)}))}><i className="fas fa-times"></i></button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                                        <div className="flex justify-between items-center mb-3 border-b pb-2">
                                            <h3 className="font-bold text-kino"><i className="fas fa-file-signature mr-2"></i>客戶資料</h3>
                                        </div>
                                        
                                        <div className="mb-6 p-3 bg-gray-50 rounded-lg border">
                                            <label className="text-sm font-bold text-kino block mb-2">甲方</label>
                                            <div className="grid grid-cols-1 gap-2">
                                                <InputGroup label="抬頭" value={data.signatures.client.company} onChange={v => updateDeep(['signatures', 'client', 'company'], v)} />
                                                <div className="grid grid-cols-2 gap-2">
                                                    <InputGroup label="代表人" value={data.signatures.client.rep} onChange={v => updateDeep(['signatures', 'client', 'rep'], v)} />
                                                    <InputGroup label="統編" value={data.signatures.client.taxId} onChange={v => updateDeep(['signatures', 'client', 'taxId'], v)} />
                                                </div>
                                                <InputGroup label="電話" value={data.signatures.client.phone} onChange={v => updateDeep(['signatures', 'client', 'phone'], v)} />
                                            </div>
                                            <div className="mt-2 h-24 border-2 border-dashed border-gray-300 rounded bg-white flex flex-col items-center justify-center overflow-hidden cursor-pointer hover:border-kino transition"
                                                 onClick={() => document.getElementById('upload-client-sig').click()}>
                                                {/* V12.9.7: 綁定到 processFileUpload */}
                                                <input type="file" id="upload-client-sig" className="hidden" accept="image/*" onChange={(e) => handleSigUpload(e, 'client')} disabled={loading}/> 
                                                {loading ? ( 
                                                    <div className="text-kino text-sm flex flex-col items-center"><i className="fas fa-spinner fa-spin text-xl mb-1"></i>載入中</div>
                                                ) : data.signatures.client.img ? 
                                                    <img src={data.signatures.client.img} className="h-full object-contain" onError={(e) => { e.target.onerror = null; e.target.src = "https://placehold.co/100x24/ffffff/6b7280?text=圖片載入失敗"; }}/> : 
                                                    <div className="text-gray-400 text-xs flex flex-col items-center"><i className="fas fa-upload mb-1"></i>點擊上傳印鑑</div>
                                                }
                                            </div>
                                        </div>

                                        <div className="p-3 bg-gray-50 rounded-lg border">
                                            <label className="text-sm font-bold text-kino block mb-2">乙方</label>
                                            <div className="grid grid-cols-1 gap-2">
                                                <InputGroup label="抬頭" value={data.signatures.vendor.company} onChange={v => updateDeep(['signatures', 'vendor', 'company'], v)} />
                                                <div className="grid grid-cols-2 gap-2">
                                                    <InputGroup label="代表人" value={data.signatures.vendor.rep} onChange={v => updateDeep(['signatures', 'vendor', 'rep'], v)} />
                                                    <InputGroup label="統編" value={data.signatures.vendor.taxId} onChange={v => updateDeep(['signatures', 'vendor', 'taxId'], v)} />
                                                </div>
                                                <InputGroup label="電話" value={data.signatures.vendor.phone} onChange={v => updateDeep(['signatures', 'vendor', 'phone'], v)} />
                                            </div>
                                            <div className="mt-2 h-24 border-2 border-dashed border-gray-300 rounded bg-white flex flex-col items-center justify-center overflow-hidden cursor-pointer hover:border-kino transition"
                                                 onClick={() => document.getElementById('upload-vendor-sig').click()}>
                                                {/* V12.9.7: 綁定到 processFileUpload */}
                                                <input type="file" id="upload-vendor-sig" className="hidden" accept="image/*" onChange={(e) => handleSigUpload(e, 'vendor')} disabled={loading}/> 
                                                {loading ? ( 
                                                    <div className="text-kino text-sm flex flex-col items-center"><i className="fas fa-spinner fa-spin text-xl mb-1"></i>載入中</div>
                                                ) : data.signatures.vendor.img ? 
                                                    <img src={data.signatures.vendor.img} className="h-full object-contain" onError={(e) => { e.target.onerror = null; e.target.src = "https://placehold.co/100x24/ffffff/6b7280?text=圖片載入失敗"; }}/> : 
                                                    <div className="text-gray-400 text-xs flex flex-col items-center"><i className="fas fa-upload mb-1"></i>點擊上傳印鑑</div>
                                                }
                                            </div>
                                        </div>

                                        <div className="mt-4">
                                            <InputGroup label="簽署日期" type="date" value={data.signatures.date} onChange={v => updateDeep(['signatures', 'date'], v)} />
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'items' && (
                                <div className="space-y-4 p-4 pb-24">
                                    <div className="flex justify-between items-center mb-2">
                                        <h2 className="font-bold text-gray-700">報價細項</h2>
                                        <button onClick={() => {
                                            const newId = Date.now();
                                            setData(prev => ({...prev, categories: [...prev.categories, { id: newId, name: '新分類', items: [] }]}));
                                        }} className="bg-kino text-white px-3 py-1 rounded-full text-sm shadow"><i className="fas fa-plus mr-1"></i>類別</button>
                                    </div>
                                    {data.categories.map((cat, catIdx) => (
                                        <div key={cat.id} className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                            <div className={`${catIdx % 2 === 0 ? 'bg-kino text-white' : 'bg-kino-medium text-white'} p-3 flex justify-between items-center`}>
                                                <input className="font-bold bg-transparent border-b border-dashed border-white/50 w-full mr-2 focus:outline-none placeholder-white/70"
                                                    value={cat.name} onChange={e => {
                                                        const newCats = [...data.categories]; newCats[catIdx].name = e.target.value; setData(prev => ({...prev, categories: newCats}));
                                                    }} />
                                                {/* V11: 避免使用 alert，改用 window.confirm 提示 */}
                                                <IconButton icon="fa-trash-alt" color="text-white/80 hover:text-white" onClick={() => {
                                                    if(window.confirm('確定刪除此分類？')) setData(prev => ({...prev, categories: prev.categories.filter(c => c.id !== cat.id)}));
                                                }} />
                                            </div>
                                            <div className="p-2 space-y-2">
                                                {cat.items.map((item, itemIdx) => (
                                                    <div key={item.id} className="bg-white border border-gray-100 rounded-lg p-3 shadow-sm">
                                                        <div className="mb-2">
                                                            <input className="w-full font-medium text-gray-800 border-b border-gray-200 focus:border-kino outline-none"
                                                                value={item.desc} placeholder="項目描述"
                                                                onChange={e => {
                                                                    const newCats = [...data.categories];
                                                                    newCats[catIdx].items[itemIdx].desc = e.target.value;
                                                                    setData(prev => ({...prev, categories: newCats}));
                                                                }} />
                                                        </div>
                                                        <div className="flex gap-2 items-end">
                                                            <div className="flex-1">
                                                                <label className="text-[10px] text-gray-400">單價</label>
                                                                {/* V11: 確保價格是數字輸入，避免 NaN 錯誤 */}
                                                                <input type="number" className="w-full text-sm border bg-gray-50 rounded px-1" value={item.price} 
                                                                    onChange={e => { const newCats = [...data.categories]; newCats[catIdx].items[itemIdx].price = e.target.value; setData(prev => ({...prev, categories: newCats})); }} />
                                                            </div>
                                                            <div className="w-16">
                                                                <label className="text-[10px] text-gray-400">數量</label>
                                                                <input type="number" className="w-full text-sm border bg-gray-50 rounded px-1 text-center" value={item.qty} 
                                                                     onChange={e => { const newCats = [...data.categories]; newCats[catIdx].items[itemIdx].qty = e.target.value; setData(prev => ({...prev, categories: newCats})); }} />
                                                            </div>
                                                            <div className="w-16">
                                                                <label className="text-[10px] text-gray-400">單位</label>
                                                                <input type="text" className="w-full text-sm border bg-gray-50 rounded px-1 text-center" value={item.unit} 
                                                                     onChange={e => { const newCats = [...data.categories]; newCats[catIdx].items[itemIdx].unit = e.target.value; setData(prev => ({...prev, categories: newCats})); }} />
                                                            </div>
                                                            <button className="text-red-300 p-1 mb-1" onClick={() => {
                                                                const newCats = [...data.categories]; newCats[catIdx].items = newCats[catIdx].items.filter(i => i.id !== item.id); setData(prev => ({...prev, categories: newCats}));
                                                            }}><i className="fas fa-times"></i></button>
                                                        </div>
                                                    </div>
                                                ))}
                                                <button onClick={() => {
                                                    const newCats = [...data.categories]; newCats[catIdx].items.push({ id: Date.now(), desc: '', unit: '式', qty: 1, price: 0 }); setData(prev => ({...prev, categories: newCats}));
                                                }} className="w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-400 hover:border-kino hover:text-kino transition text-sm font-bold">
                                                    <i className="fas fa-plus mr-1"></i> 新增細項
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}

                            {activeTab === 'terms' && (
                                <div className="space-y-4 p-4 pb-24">
                                    {/* V12.1: 客製化備註 (已移除條列式後綴，並改為拖曳排序) */}
                                    <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                                        <div className="flex justify-between items-center mb-3 border-b pb-2">
                                            <h3 className="font-bold text-kino"><i className="fas fa-pen-nib mr-2"></i>客製化備註</h3>
                                            <button onClick={() => setData(prev => ({...prev, notes: [...prev.notes, '']}))} 
                                                className="text-xs bg-gray-100 px-2 py-1 rounded hover:bg-gray-200"><i className="fas fa-plus"></i></button>
                                        </div>
                                        <div className="space-y-3">
                                            {data.notes.map((note, idx) => (
                                                <div key={idx} 
                                                    /* V12.9 修正: 在外層 div 加入 select-none，解決手機長按拖曳時誤選文字的問題 */
                                                    className="flex items-start gap-2 bg-gray-50 p-2 rounded-lg border border-gray-200 hover:shadow-md transition select-none"
                                                    draggable
                                                    onDragStart={(e) => handleDragStart(e, idx)}
                                                    onDragEnter={(e) => handleDragEnter(e, idx)}
                                                    onDragOver={(e) => e.preventDefault()}
                                                    onDragEnd={handleDragEnd}
                                                >
                                                    {/* V12.3 修正: 拖曳把手改用 fa-bars 且移除旋轉 (模擬水平「三」字) */}
                                                    {/* V12.4 修正: 增加 select-none 避免手機上拖曳時選取文字 */}
                                                    <div className="flex flex-col items-center justify-center h-full pt-2 cursor-grab text-gray-400 hover:text-kino transition select-none">
                                                        <i className="fas fa-bars text-lg"></i>
                                                    </div>

                                                    <span className="text-kino font-bold mt-2 text-sm shrink-0">{idx + 1}.</span>
                                                    <textarea 
                                                        className="w-full p-2 border border-gray-300 rounded-lg text-sm leading-relaxed focus:border-kino outline-none bg-white"
                                                        rows={2}
                                                        value={note}
                                                        onChange={e => {
                                                            const newNotes = [...data.notes];
                                                            newNotes[idx] = e.target.value;
                                                            setData(prev => ({...prev, notes: newNotes}));
                                                        }}
                                                    />
                                                    <div className="flex flex-col gap-1 mt-1 shrink-0">
                                                        {/* 僅保留刪除按鈕 */}
                                                        <button className="text-red-300 hover:text-red-500 p-1" onClick={() => setData(prev => ({...prev, notes: prev.notes.filter((_, i) => i !== idx)}))}>
                                                            <i className="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    {/* V10: 4. 付款方式 (Swapped to Bottom) */}
                                    <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                                        <div className="flex justify-between items-center mb-3 border-b pb-2">
                                            <h3 className="font-bold text-kino"><i className="fas fa-list-ol mr-2"></i>付款條件</h3>
                                            <div className="flex items-center gap-2">
                                                {/* V12.9.3: 新增預設選單 */}
                                                <select 
                                                    className="text-xs border border-gray-300 rounded p-1.5 bg-white shadow-sm focus:border-kino focus:ring-kino"
                                                    onChange={(e) => applyPaymentPreset(e.target.value)}
                                                >
                                                    <option value="" disabled selected>— 套用預設 —</option>
                                                    <option value="default">三期 (4:3:3)</option>
                                                    <option value="two_parts">兩期 (5:5)</option>
                                                    <option value="full_payment_upfront">一期 (簽約後 100%)</option>
                                                    <option value="full_payment_upon_completion">一期 (交付後 100%)</option>
                                                </select>

                                                <button onClick={() => setData(prev => ({...prev, payment: [...prev.payment, {id: Date.now(), stage: '新階段', percent: 0, condition: '', note: ''}]}))} 
                                                    className="text-xs bg-gray-100 px-2 py-1 rounded hover:bg-gray-200"><i className="fas fa-plus"></i></button>
                                            </div>
                                        </div>
                                        <div className="space-y-4">
                                            {data.payment.map((term, idx) => (
                                                <div key={term.id} className="bg-gray-50 p-3 rounded-lg border border-gray-200 relative">
                                                    <button className="absolute top-2 right-2 text-red-300 hover:text-red-500" onClick={() => setData(prev => ({...prev, payment: prev.payment.filter(p => p.id !== term.id)}))}><i className="fas fa-times"></i></button>
                                                    <div className="grid grid-cols-1 gap-2">
                                                        <InputGroup label={`階段 ${idx+1}`} value={term.stage} onChange={v => {const newPay=[...data.payment]; newPay[idx].stage=v; setData(prev=>({...prev,payment:newPay}))}} />
                                                        <div className="flex gap-2">
                                                            <div className="w-1/3"><InputGroup label="比例 (%)" type="number" value={term.percent} onChange={v => {const newPay=[...data.payment]; newPay[idx].percent=v; setData(prev=>({...prev,payment:newPay}))}} /></div>
                                                            <div className="w-2/3"><InputGroup label="付款條件" value={term.condition} onChange={v => {const newPay=[...data.payment]; newPay[idx].condition=v; setData(prev=>({...prev,payment:newPay}))}} /></div>
                                                        </div>
                                                        <InputGroup label="備註" value={term.note} onChange={v => {const newPay=[...data.payment]; newPay[idx].note=v; setData(prev=>({...prev,payment:newPay}))}} />
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                                        <h3 className="font-bold text-kino"><i className="fas fa-university mr-2"></i>收款帳戶</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-x-4">
                                            <InputGroup label="銀行名稱" value={data.bank.bank} onChange={v => updateDeep(['bank', 'bank'], v)} />
                                            <InputGroup label="戶名" value={data.bank.name} onChange={v => updateDeep(['bank', 'name'], v)} />
                                            <InputGroup label="帳號" value={data.bank.acc} onChange={v => updateDeep(['bank', 'acc'], v)} />
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'preview' && (
                                <div className="p-4 bg-gray-200 min-h-screen">
                                    <div className="no-print bg-white p-3 rounded mb-4 shadow flex flex-wrap gap-4 items-center justify-between">
                                        <div className="flex flex-wrap gap-3 text-sm font-bold text-gray-700">
                                            <label className="flex items-center gap-1 cursor-pointer">
                                                <input type="checkbox" checked={previewSettings.showDetails} 
                                                    onChange={e => setPreviewSettings(prev => ({...prev, showDetails: e.target.checked}))} /> 
                                                列印細項
                                            </label>
                                            <label className="flex items-center gap-1 cursor-pointer">
                                                <input type="checkbox" checked={previewSettings.showSigDate} 
                                                    onChange={e => setPreviewSettings(prev => ({...prev, showSigDate: e.target.checked}))} /> 
                                                簽署日期
                                            </label>
                                            <label className="flex items-center gap-1 cursor-pointer">
                                                <input type="checkbox" checked={previewSettings.singlePageMode} 
                                                    onChange={e => setPreviewSettings(prev => ({...prev, singlePageMode: e.target.checked}))} /> 
                                                單頁列印 (縮放 70%)
                                            </label>
                                        </div>
                                        {/* V11: 移除 HTML5 警告符號，使用 <button> 替代 */}
                                        <button onClick={() => window.print()} className="bg-kino text-white px-4 py-1.5 rounded shadow hover:bg-kino-light text-sm font-bold">
                                            <i className="fas fa-print mr-1"></i> 列印 / PDF
                                        </button>
                                    </div>
                                    
                                    <div className="screen-preview origin-top w-full overflow-x-auto">
                                        <PreviewSection data={data} settings={previewSettings} />
                                    </div>
                                </div>
                            )}
                        </div>

                         {activeTab === 'items' && (
                             <div className="fixed bottom-0 left-0 right-0 bg-white border-t p-3 flex justify-between items-center shadow-lg z-40 max-w-screen-md mx-auto">
                                <select className="text-xs border rounded p-1" value={data.taxMode} onChange={e => updateDeep(['taxMode'], e.target.value)}>
                                    <option value="excluded">報價未稅</option>
                                    <option value="inclusive_flat">報價含稅</option> 
                                    <option value="included">稅外(5%)</option>
                                </select>
                                <div className="text-right">
                                    <div className="text-xs text-gray-500">總金額</div>
                                    <div className="text-lg font-bold text-kino">NT$ {totals().toLocaleString()}</div>
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="print-layer hidden print:block">
                        <PreviewSection data={data} settings={previewSettings} />
                    </div>
                </div>
            );
        }

        // --- 列印版面 (V13.0.1: 簽署佔比調整) ---
        const PreviewSection = ({ data, settings }) => {
            let subtotal = 0;
            // V11: 確保價格和數量是數字類型
            data.categories.forEach(cat => cat.items.forEach(i => subtotal += (Number(i.price)||0)*(Number(i.qty)||0)));
            let tax = Math.round(subtotal * 0.05);
            let total = subtotal;
            let taxText = "(未稅)";
            if (data.taxMode === 'included') { total = subtotal + tax; taxText = "(含稅)"; }
            else if (data.taxMode === 'inclusive_flat') { taxText = "(含稅)"; }

            const containerClass = `print-container relative mx-auto max-w-[210mm] shadow-lg print:shadow-none p-[10mm] print:p-0 ${settings.singlePageMode ? 'single-page-mode' : ''}`;

            // V11: 分頁邏輯更新
            // Section IV (付款方式) 的條件分頁：在非單頁模式下強制分頁
            const paymentBreakClass = settings.singlePageMode ? '' : 'page-break-conditional page-break'; 
            // Section VI (詳細細項) 總是強制分頁 
            const detailedBreakClass = 'page-break detailed-services-page-break';
            
            // V12.4: 柔和灰色
            const softGray = '#394150';

            // V12.9.4 修正: 逾期付款警示顏色改為暗紅色 (#B91C1C)
            const warningRed = '#B91C1C';
            
            // V12.9.8 修正: 調整為 10% 邊框
            const signatureStyle = { 
                padding: '10%', // 留 10% 邊框
                position: 'relative' // 確保絕對定位的圖片能相對於此單元格
            };
            
            // V13.0.1 修正: 圖片佔比調整為 85% (即留白 15% / 2 = 7.5% 邊框)
            const imageStyle = {
                position: 'absolute',
                top: 0,
                bottom: 0,
                left: 0,
                right: 0,
                margin: 'auto', // 居中
                maxWidth: '85%', // 佔據 85% 空間
                maxHeight: '85%', // 佔據 85% 空間
                objectFit: 'scale-down' 
            };

            return (
                <div className={containerClass}>
                    {/* Header */}
                    <div className="grid grid-cols-3 items-center mb-2 pb-2 border-b-4 border-kino">
                            <div className="flex items-center justify-start h-16">
                            {data.logo && <img src={data.logo} className="max-h-full max-w-[120px] object-contain" onError={(e) => { e.target.onerror = null; e.target.src = "https://placehold.co/100x24/f0f6fa/6b7280?text=圖片載入失敗"; }} />}
                            </div>
                            {/* V12 修正: 標題確保不分行，已修改 CSS 為 18pt */}
                            <h1 className="text-center whitespace-nowrap">奇諾影像報價單(Quotation)</h1>
                            <div className="text-right text-xs"></div>
                    </div>

                    {/* Info Grid */}
                    <div className="grid grid-cols-3 gap-2 mb-2 text-xs sm:text-sm">
                        {/* V12.4 修正: 標題顏色改為 softGray */}
                        <div><span className="font-bold block" style={{ color: softGray }}>報價單號</span><span className="text-kino font-bold text-base">{data.header.id}</span></div>
                        <div><span className="font-bold block" style={{ color: softGray }}>報價日期</span>{data.header.date}</div>
                        <div><span className="font-bold block" style={{ color: softGray }}>有效期限</span>{data.header.valid}</div>
                    </div>

                    {/* I. Project Overview (V7: mb-2 for spacing) */}
                    <div className="mb-2 avoid-break">
                        <h2>一、 專案內容</h2>
                        {/* V12.8 修正: 僅在專案內容概況中縮排，調整為 pl-14 */}
                        <div className="grid grid-cols-2 gap-x-4 gap-y-1 text-xs sm:text-sm pl-14">
                            {data.projectFields.map(f => (
                                // V12.4 修正: 標題顏色改為 softGray
                                <div key={f.id}><span className="font-bold mr-1" style={{ color: softGray }}>{f.label}:</span>{f.value}</div>
                            ))}
                        </div>
                    </div>

                    {/* II. Summary */}
                    <div className="mb-2 avoid-break">
                        <h2>二、 專案報價</h2>
                        <div className="table-rounded-wrapper">
                            <table className="w-full text-xs sm:text-sm">
                                <thead className="bg-kino text-white">
                                    <tr>
                                        <th className="p-1 text-left border-b border-black">摘要</th>
                                        <th className="p-1 text-right w-32 border-b border-black border-l border-white/20">總計 (NTD)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {data.categories.map(cat => {
                                        const total = cat.items.reduce((acc, i) => acc + (Number(i.price) * Number(i.qty)), 0); 
                                        return (
                                            <tr key={cat.id}>
                                                {/* V12.4 修正: 摘要內的細項文字顏色改為 softGray */}
                                                <td className="p-1 pl-2 font-bold border-b border-black" style={{ color: softGray }}>{cat.name}</td>
                                                <td className="p-1 text-right font-bold border-b border-black border-l">${total.toLocaleString()}</td>
                                            </tr>
                                        )
                                    })}
                                </tbody>
                            </table>
                        </div>
                        <div className="flex justify-end mt-1">
                            {/* V12.4 修正: 總計區塊寬度，使用 max-w-full 確保 RWD (需求 3) */}
                            <div className={`max-w-full sm:w-1/2 text-xs sm:text-sm table-rounded-wrapper`}>
                                <div className="flex justify-between p-1 px-2 border-b border-black bg-gray-50">
                                    <span>服務項目總計 (∆)</span>
                                    <span className="font-bold">${subtotal.toLocaleString()}</span>
                                </div>
                                {data.taxMode === 'included' && (
                                        <div className="flex justify-between p-1 px-2 border-b border-black bg-gray-50">
                                        <span>營業稅 (5%)</span>
                                        <span>${tax.toLocaleString()}</span>
                                    </div>
                                )}
                                <div className="flex justify-between p-1 px-2 bg-kino text-white items-center">
                                    <span className="font-bold">本次報價總金額 {taxText}</span>
                                    <span className="font-bold text-base sm:text-lg">${total.toLocaleString()}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* III. Notes (Moved to III) - V12.1: 修正標題 */}
                    <div className={`mb-2 avoid-break`}>
                        <h2>三、 客製化備註</h2>
                        {/* V12.5 修正: 取消內文容器的 padding 縮排設定 */}
                        <div className="bg-kino-50 rounded-lg p-2 text-xs sm:text-sm leading-relaxed">
                            {/* 列表保留 pl-5 讓編號出現，但外層 div 上的 padding 已移除 */}
                            <ol className="list-decimal pl-5 space-y-0.5 marker:text-kino marker:font-bold">
                                {data.notes.map((note, i) => <li key={i}>{note}</li>)}
                            </ol>
                        </div>
                    </div>

                    {/* IV. Terms (Moved to IV) - Conditional page break (依據需求 2) */}
                    <div className={`mb-2 avoid-break ${paymentBreakClass}`}>
                        <h2>四、 付款方式與條款</h2>
                        <div className="table-rounded-wrapper mb-2">
                            <table className="w-full text-xs sm:text-sm">
                                <thead className="bg-kino text-white">
                                    <tr>
                                        <th className="p-1 w-1/5 border-b border-black">階段</th>
                                        <th className="p-1 w-16 text-center border-b border-black border-l border-white/20">比例</th>
                                        <th className="p-1 border-b border-black border-l border-white/20">付款條件</th>
                                        <th className="p-1 border-b border-black border-l border-white/20">備註</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {data.payment.map(term => (
                                        <tr key={term.id}>
                                            <td className="p-1 font-bold border-b border-black">{term.stage}</td>
                                            <td className="p-1 text-center font-bold text-kino border-b border-black border-l">{term.percent}%</td>
                                            <td className="p-1 border-b border-black border-l">{term.condition}</td>
                                            <td className="p-1 border-b border-black border-l">{term.note}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        {/* V12.8 修正: 匯款資訊強制不分段，使用 flex-nowrap 並保持 whitespace-nowrap */}
                        <div className="table-rounded-wrapper p-2 bg-gray-50 text-xs sm:text-sm flex flex-nowrap gap-x-4 gap-y-1 overflow-x-auto">
                            <span className="font-bold text-kino whitespace-nowrap">收款資訊：</span>
                            <span className="whitespace-nowrap"><b>銀行:</b> {data.bank.bank}</span>
                            <span className="whitespace-nowrap"><b>戶名:</b> {data.bank.name}</span>
                            <span className="whitespace-nowrap"><b>帳號:</b> {data.bank.acc}</span>
                        </div>
                        {/* V12.9.4 修正: 逾期付款警示顏色改為暗紅色 (#B91C1C) */}
                        <div className="text-[10px] mt-1 font-medium" style={{ color: warningRed }}>
                            ** 逾期付款：若甲方逾期、未足額支付任何一期款項，乙方有權暫停後續的製作或交付工作，直至款項結清。
                        </div>
                    </div>

                    {/* V. Signatures - 報價簽署不分頁 (需求 2) */}
                    <div className={`mb-2 avoid-break`}> 
                        <h2>五、 簽署</h2>
                        <div className="overflow-x-auto w-full table-rounded-wrapper">
                             <table className="w-full text-xs sm:text-sm">
                                <thead className="bg-kino-50">
                                    <tr>
                                        <th className="p-1 w-1/6 font-normal border-b border-black">項目</th>
                                        <th className="p-1 w-5/12 font-normal border-b border-black border-l">甲方</th>
                                        <th className="p-1 w-5/12 font-normal border-b border-black border-l">乙方</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td className="p-1 font-bold bg-gray-50 text-center border-b border-black">抬頭</td>
                                        <td className="p-1 text-center font-bold text-kino border-b border-black border-l">{data.signatures.client.company}</td>
                                        <td className="p-1 text-center font-bold text-kino border-b border-black border-l">{data.signatures.vendor.company}</td>
                                    </tr>
                                    <tr>
                                        <td className="p-1 font-bold bg-gray-50 text-center border-b border-black">代表人</td>
                                        <td className="p-1 text-center font-bold text-kino border-b border-black border-l">{data.signatures.client.rep}</td>
                                        <td className="p-1 text-center font-bold text-kino border-b border-black border-l">{data.signatures.vendor.rep}</td>
                                    </tr>
                                    <tr>
                                        <td className="p-1 font-bold bg-gray-50 text-center border-b border-black">統一編號</td>
                                        <td className="p-1 text-center font-bold text-kino border-b border-black border-l">{data.signatures.client.taxId}</td>
                                        <td className="p-1 text-center font-bold text-kino border-b border-black border-l">{data.signatures.vendor.taxId}</td>
                                    </tr>
                                    <tr>
                                        <td className="p-1 font-bold bg-gray-50 text-center border-b border-black">聯絡電話</td>
                                        <td className="p-1 text-center font-bold text-kino border-b border-black border-l">{data.signatures.client.phone}</td>
                                        <td className="p-1 text-center font-bold text-kino border-b border-black border-l">{data.signatures.vendor.phone}</td>
                                    </tr>
                                    <tr>
                                        <td className="p-1 font-bold bg-gray-50 text-center align-middle border-b border-black">簽署</td>
                                        {/* V12.9.5 修正: 增加 h-32 行高 */}
                                        {/* V13.0.1 修正: 邊框調整為 85% 佔比 (留白 7.5%) */}
                                        <td className="h-32 relative border-b border-black border-l" style={signatureStyle}>
                                             {/* V13.0.1 修正: 調整圖片樣式，maxWidth/maxHeight 設為 85% */}
                                             {data.signatures.client.img && <img src={data.signatures.client.img} style={imageStyle} onError={(e) => { e.target.onerror = null; e.target.src = "https://placehold.co/100x24/ffffff/6b7280?text=圖片載入失敗"; }} />}
                                        </td>
                                        <td className="h-32 relative border-b border-black border-l" style={signatureStyle}>
                                             {data.signatures.vendor.img && <img src={data.signatures.vendor.img} style={imageStyle} onError={(e) => { e.target.onerror = null; e.target.src = "https://placehold.co/100x24/ffffff/6b7280?text=圖片載入失敗"; }} />}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td className="p-1 font-bold bg-gray-50 text-center border-b border-black">日期</td>
                                        <td className="p-1 text-center font-bold text-kino border-b border-black border-l" colSpan="2">{settings.showSigDate ? data.signatures.date : ''}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* VI. Detailed Services (Always break, 依據需求 1) */}
                    {settings.showDetails && (
                        <div className={`mt-4 ${detailedBreakClass}`}>
                            <h2 className="text-kino mb-3 border-l-4 border-kino pl-2">六、 服務細項清單</h2>
                            {data.categories.map((cat, idx) => {
                                const isDark = idx % 2 === 0;
                                return (
                                    <div key={cat.id} className="mb-4 avoid-break table-rounded-wrapper">
                                        <div className={`p-1 pl-2 font-bold text-white text-sm ${isDark ? 'bg-kino-darker' : 'bg-kino-medium'}`}>
                                            {cat.name}
                                        </div>
                                        <table className="w-full text-xs sm:text-sm">
                                            <thead className="bg-gray-100">
                                                <tr>
                                                    <th className="p-1 text-left w-1/2 border-b border-black">項目</th>
                                                    <th className="p-1 w-12 text-center border-b border-black border-l">數量</th>
                                                    <th className="p-1 w-12 text-center border-b border-black border-l">單位</th>
                                                    <th className="p-1 text-right w-24 border-b border-black border-l">單價</th>
                                                    <th className="p-1 text-right w-24 border-b border-black border-l">小計</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {cat.items.map(item => (
                                                    <tr key={item.id}>
                                                        <td className="p-1 border-b border-black">{item.desc}</td>
                                                        <td className="p-1 text-center border-b border-black border-l">{item.qty}</td>
                                                        <td className="p-1 text-center border-b border-black border-l">{item.unit}</td>
                                                        <td className="p-1 text-right border-b border-black border-l">${Number(item.price).toLocaleString()}</td>
                                                        <td className="p-1 text-right font-bold border-b border-black border-l">${(Number(item.price) * Number(item.qty)).toLocaleString()}</td> 
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                )
                            })}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
