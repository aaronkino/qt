<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>奇諾影像報價單生成器 (v47 - 稅額計算模式更新)</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        kino: {
                            DEFAULT: '#105482', // 企業標準色 (深)
                            light: '#1e6fa5',
                            dark: '#0c3e60',
                            50: '#f0f6fa', // 極淡標準色 (淺)
                        },
                        // V39: 新增兩種顏色用於第六項標題交替配色
                        'kino-darker': '#31557e', 
                        'kino-medium': '#4470a0', 
                    }
                }
            }
        }
    </script>
    <!-- 引入 Font Awesome 實用圖示 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- V46 (b): 完整版本更新日誌 (不顯示於網頁) -->
    <!--
    --- 奇諾影像報價單生成器 - 完整版本更新歷史 (V01 - V47) ---
    
    [V01 – V11: 基礎架構與核心功能確立]
    V01 (初始版本): 基礎結構, 自動計算, JSON儲存/讀取, Logo/數位簽名功能, 報價單號自動化 (YYMMDD 專案名稱_01)。
    V02: 新增「列印包含細項」開關, 儲存機制改為下載.json。
    V05: 移除版本號/中文大寫。報價單號自動化改為 YYMMDD 專案名稱_01。導入企業色 #105482。
    V06: 付款條款動態增減, 新增數位簽署圖片上傳。
    V07: 標題更新, 新增 Logo 上傳區域。
    V08: 更新客製化細節為 6 點制式合約, 單號後綴改為 _KS01, 總計代號由 (A) 改為 (X)。
    V09: 限制 Logo 尺寸, 調整預設付款比例。
    V10: 統一欄位名稱, 修復預設合約文字顯示問題。
    V11: 總計代號 (X) 改為 (∆), 列印優化 (break-inside: avoid)。
    
    [V12 – V31: 列印穩定、動態化與視覺優化]
    V12: 銀行帳號移至付款方式下方。強制分頁 (Section IV/VI 前換頁)。
    V16: 導入動態摘要增減功能, 加入 localStorage 自動暫存。
    V17: 加大簽署區表格內距與簽名欄高度。
    V18: 加入 AI 建議細項功能 (Gemini API)。
    V19 ~ V20: Logo Base64 內嵌, 手機表格支援橫向捲動 (RWD)。
    V21: 下載功能改用 showSaveFilePicker, 修正報價單號/預設日期/有效期限。
    V22: 修正 populateForm 日期同步, 預設單價設為 0。
    V23: 調整 defaultNotes 內文軟換行結構。
    V24: 列印邊界統一為 12mm, 統一表格列印邊線為 1px。
    V26: 簽署區高度增為 160px, 修復簽署日期顯示同步問題。
    V29: 簽署區表格字體設為 text-sm (非粗體)。
    V30: 乙方簽署欄位改為可編輯並預填資料, 報價單號強制三欄並排。
    V31: 乙方收款資訊字級調整為 text-base, 細項摘要標題列深淺交替顯示。

    [V32 – V47: 列印精準控制與邊框調整]
    V32: 修正收款資訊強制水平佈局。新增「單頁列印」 (縮放 0.65) 與「列印頁碼」(嘗試)。
    V33: 移除頁碼功能。調整單頁列印模式下 Section VI 仍從新頁開始。
    V34: 調整「單頁列印」縮放比例為 0.55。
    V35: 「縮放列印」改名為「單頁列印」，與「簽署日期」互換位置。修正表格邊框為 1px。
    V36: 根據反饋，強制所有表格及總計區塊邊框設為 2px 黑色實線。
    V38: 修正列印 Logo 顯示邏輯，確保圖片在列印時可見，且隱藏 UI 元素。
    V39: 細項摘要標題配色調整為 #31557e 與 #4470a0 交替。
    V40: 修正 Logo 垂直對齊問題：移除 V39 複雜置中邏輯，改用 Logo 絕對定位 + H1 左右 padding 的原始方法，確保 Logo 靠左且標題在視覺上置中。
    V41: 修正標題視覺置中問題：改用 3 欄 Grid 佈局，讓標題在中間欄位自然置中。
    V42: 強制 H1 標題在單行顯示，避免因 Grid 欄寬不足而分段。
    V43: 修正列印 H2 標題字級過小問題；清理 defaultCategories 中的遺留 color 屬性。
    V44: 修正列印 H3 標題字級過小問題，使其在列印時為 12pt。
    V45: RWD 優化，所有表格增加橫向捲動容器 (overflow-x-auto) 與最小寬度設定，改善手機填寫體驗。
    V46: 修復 populateForm 與 collectQuotationData 中的 JS 選擇器錯誤，解決因 v45 變更 class 導致的 null pointer exception。
    V47 (本版): 稅額計算模式更新。新增「報價含稅」選項；原「未稅」改名「報價未稅」；原「含稅(5%)」改名「稅外(5%)」。
    -->
    
    <style>
        /* 專為列印優化 */
        @media print {
            @page {
                size: A4;
                margin: 12mm;
            }
            .no-print {
                display: none !important;
            }
            body {
                margin: 0;
                padding: 0;
                zoom: 0.95; /* 預設縮放 */
                -webkit-print-color-adjust: exact;
                font-size: 12px;
            }
            .page-container {
                box-shadow: none;
                margin: 0;
                padding: 0;
                width: 100% !important;
                max-width: none !important;
                border: none !important; 
            }
            input, textarea, select {
                border: none !important;
                padding: 0 !important;
                background-color: transparent !important;
                box-shadow: none !important;
                appearance: none;
                font-size: inherit;
                resize: none;
            }
            /* Logo 處理 */
            #logo-placeholder { display: none !important; }
            #logo-wrapper.has-no-logo { display: none !important; }
            /* Logo 圖片強制顯示，並保持其在絕對定位容器內的位置 */
            #logo-img { display: block !important; } 

            table {
                border-collapse: collapse;
                width: 100%;
            }
            /* 修正: 確保所有 table cell 在列印時都有 2px 邊框 */
            th, td {
                border: 2px solid #000 !important; 
            }

            /* 強制所有表格及總金額區塊的外層邊框為 2px 黑色實線 */
            .summary-table, .item-table, .signature-table, .summary-block {
                 border: 2px solid #000 !important;
            }
            
            h1, h2, h3, h4 {
                break-after: avoid; 
                page-break-after: avoid;
            }
            
            /* V43 修正: 確保 h2 標題在列印時足夠大 (Section I, IV, V, VI) */
            h2 {
                 font-size: 14pt !important; /* 約 18.6px */
            }
            
            /* V44 修正: 確保 h3 摘要標題在列印時字級適中 */
            h3 {
                 font-size: 12pt !important; /* 約 16px */
            }

            .section-block {
                break-inside: avoid;
                page-break-inside: avoid;
            }
            /* 預設分頁設定 */
            .payment-section-container {
                break-before: page;
                page-break-before: always;
                margin-top: 20px; 
            }
            
            .detailed-section { 
                break-before: page; 
                page-break-before: always;
                margin-top: 0 !important;
                padding-top: 20px;
                border-top: none !important;
            }
            
            body.print-hide-details .detailed-section { display: none !important; }
            tr.hide-date-row { display: none !important; }
            .upload-hint { display: none !important; }
            
            /* 列印時 H1 繼承標準樣式，現在由 Grid 置中 */
            h1 { 
                margin-bottom: 10px !important; 
                font-size: 1.5rem !important; 
                padding-left: 0 !important;
                padding-right: 0 !important;
            }
            
            .mb-6 { margin-bottom: 10px !important; }
            .p-4, .p-6, .p-10 { padding: 0 !important; }
            .gap-4 { gap: 0.5rem !important; }

            .summary-table {
                /* 繼承上面的 .summary-table 樣式，但確保其外邊框存在 */
                border-collapse: collapse !important;
            }
            /* 修正: summary-table 內的 cell 也要 2px */
            .summary-table th, .summary-table td {
                border: 2px solid #000 !important;
            }

            .signature-block .summary-table {
                font-size: 120% !important; 
            }
            .signature-block .summary-table th, 
            .signature-block .summary-table td {
                padding: 10px !important; 
            }
            .signature-block h2 {
                font-size: 1.3rem !important; 
            }

            /* 列印時編輯器樣式調整 */
            #notes-list-editor {
                border: none !important;
                padding: 0 !important;
                background-color: #f0f6fa !important; 
            }
            
            /* 強制報價單號區塊在列印時為 3 欄並排 */
            .header-info-grid {
                display: grid !important;
                grid-template-columns: repeat(3, minmax(0, 1fr)) !important;
                gap: 1rem !important;
            }
            
            /* 確保收款資訊在列印時不換行，並平均分配欄寬 */
            .bank-info-grid {
                display: grid !important;
                grid-template-columns: repeat(3, minmax(0, 1fr)) !important;
                gap: 0.5rem !important; /* 確保間距小 */
            }
            .bank-info-grid input {
                 /* 確保 input 能夠填滿分配到的空間 */
                 width: 100% !important;
            }

            /* 修正: 縮放列印模式 (0.65 -> 0.55) */
            body.print-scaled {
                zoom: 0.55 !important; /* 縮小比例 */
            }
            /* 修正: 讓 Section I-V 保持在同一頁 (如果空間足夠) */
            body.print-scaled .payment-section-container {
                break-before: avoid !important;
                page-break-before: avoid !important;
                margin-top: 0 !important;
            }
            /* 修正: 讓 Section VI 依然換頁 */
            body.print-scaled .detailed-section { 
                break-before: page !important;
                page-break-before: always !important;
                margin-top: 0 !important; 
            }

            /* 重置: 移除 page-container 上的陰影/邊框 */
            .page-container {
                border: none !important;
                box-shadow: none !important;
            }
            
            /* V45: 確保 RWD 模式下，橫向捲動的表格在列印時顯示完整 (移除捲軸) */
            .overflow-x-auto {
                overflow-x: visible !important;
            }

        }

        /* 自定義字體和基礎樣式 */
        body {
            font-family: 'Inter', 'Noto Sans CJK TC', sans-serif;
            background-color: #f4f7f9;
        }

        .quotation-input {
            width: 100%;
            padding: 4px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            transition: all 0.2s;
            text-align: inherit;
            min-width: 0;
        }
        .quotation-input:focus {
            border-color: #105482;
            outline: none;
            box-shadow: 0 0 0 2px rgba(16, 84, 130, 0.2);
        }
        
        .header-label {
            font-size: 0.75rem;
            font-weight: 700;
            color: #374151;
            margin-bottom: 0.25rem;
        }
        .header-input {
            font-size: 0.8rem;
            padding: 2px 4px;
        }

        .item-table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 10px;
            /* 確保在非列印模式下也有邊框 */
            border: 1px solid #e5e7eb; 
        }
        .item-table thead th {
            border: 1px solid #e5e7eb;
            padding: 4px 8px;
        }
        .item-table tbody td {
            border-bottom: 1px solid #e5e7eb;
            vertical-align: middle;
            padding: 4px 8px;
        }
        
        tr.hide-date-row { display: none; }

        /* 簽名區域 */
        .signature-area {
            position: relative;
            height: 160px;
            display: flex;
            align-items: end;
            justify-content: center;
        }
        .signature-img {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            max-height: 140px; 
            max-width: 100%;
            z-index: 10;
            pointer-events: none; 
        }
        .signature-upload-wrapper:hover .upload-hint { opacity: 1; }
        
        /* Logo 上傳區塊 */
        #logo-wrapper { 
            transition: opacity 0.2s; 
            position: relative; 
        }
        #logo-wrapper.has-no-logo:hover #logo-placeholder {
            background-color: #e5e7eb;
            color: #374151;
        }
        #logo-wrapper:not(.has-no-logo) #logo-placeholder {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 32px !important;
            height: 32px !important;
            opacity: 0.3;
            background-color: rgba(255, 255, 255, 0.8);
            border-color: #999;
            z-index: 20;
            transition: opacity 0.2s, transform 0.2s;
        }
        #logo-wrapper:not(.has-no-logo):hover #logo-placeholder {
            opacity: 0.9;
            transform: translate(-50%, -50%) scale(1.1);
        }
        #logo-img {
            max-height: 56px; 
            max-width: 120px; 
            object-fit: contain;
        }

        .summary-table {
            border-collapse: collapse;
            border: 1px solid #e5e7eb; 
        }
        .summary-table th, .summary-table td {
            padding: 6px 8px; 
            border: 1px solid #e5e7eb; 
        }

        /* Word 風格自動編號編輯器樣式 */
        #notes-list-editor {
            counter-reset: item;
            list-style-type: none;
            padding: 0;
            margin: 0;
            outline: none; 
        }
        #notes-list-editor li {
            display: block;
            position: relative;
            padding-left: 2em; 
            margin-bottom: 0.5em; 
            line-height: 1.6;
            text-align: justify;
        }
        #notes-list-editor li:focus {
            background-color: rgba(16, 84, 130, 0.05); 
        }
        #notes-list-editor li::before {
            content: counter(item) ".";
            counter-increment: item;
            position: absolute;
            left: 0;
            top: 0;
            font-weight: bold;
            color: #105482; 
            width: 1.5em;
            text-align: right;
            pointer-events: none; 
        }

        .detailed-section {
            margin-top: 20px;
            padding-top: 20px;
        }
        /* 手機版收款資訊網格佈局 */
        .bank-info-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 0.5rem;
        }
        /* 修正: 確保 grid item 內部的 flex 元素不換行，並讓 input 佔據剩餘空間 */
        .bank-info-grid .flex {
            flex-wrap: nowrap;
        }
        .bank-info-grid input {
            /* 修正: 替換 w-full 為 flex-1 */
            flex: 1; 
            min-width: 0; /* 讓 flex-1 能正確縮小 */
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-5xl mx-auto bg-white rounded-xl shadow-2xl p-6 sm:p-10 page-container">
        
        <!-- 控制面板 -->
        <div class="no-print mb-6 text-center bg-gray-100 p-3 rounded-lg shadow-md">
            <div id="status-message" class="text-sm text-kino mb-2 font-medium">應用程式已初始化 (v47 - 稅額計算模式更新)。</div>
            <div class="flex flex-wrap justify-center items-center gap-4">
                <button id="saveBtn" class="bg-kino hover:bg-kino-dark text-white font-bold py-1 px-3 text-sm rounded-lg shadow-lg transition duration-150 ease-in-out">
                    <i class="fas fa-download mr-1"></i>另存新檔
                </button>

                <input type="file" id="fileInput" class="hidden" style="display:none" accept=".json">

                <button id="loadBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-1 px-3 text-sm rounded-lg shadow-lg transition duration-150 ease-in-out">
                    <i class="fas fa-folder-open mr-1"></i>開啟舊檔
                </button>
                
                <label class="flex items-center space-x-2 cursor-pointer bg-white px-3 py-1 rounded-lg border border-gray-300 shadow-sm hover:bg-gray-50 transition select-none">
                    <input type="checkbox" id="print-details-toggle" class="form-checkbox h-4 w-4 text-kino" checked>
                    <span class="text-xs font-bold text-gray-700">列印細項</span>
                </label>
                
                <!-- (a) 簽署日期 (原為第三個，移動到第二個位置) -->
                <label class="flex items-center space-x-2 cursor-pointer bg-white px-3 py-1 rounded-lg border border-gray-300 shadow-sm hover:bg-gray-50 transition select-none">
                    <input type="checkbox" id="show-sig-date-toggle" class="form-checkbox h-4 w-4 text-kino" checked>
                    <span class="text-xs font-bold text-gray-700">簽署日期</span>
                </label>

                <!-- (a) 單頁列印 (原為第二個，移動到第三個位置並改名) -->
                <label class="flex items-center space-x-2 cursor-pointer bg-white px-3 py-1 rounded-lg border border-gray-300 shadow-sm hover:bg-gray-50 transition select-none">
                    <input type="checkbox" id="print-mode-scaled" class="form-checkbox h-4 w-4 text-kino">
                    <span class="text-xs font-bold text-gray-700">單頁列印</span>
                </label>
                
                <button id="printBtn" class="bg-kino hover:bg-kino-dark text-white font-bold py-1 px-3 text-sm rounded-lg shadow-lg transition duration-150 ease-in-out">
                    <i class="fas fa-print mr-1"></i>列印
                </button>
            </div>
        </div>

        <!-- 標題區塊 -->
        <!-- V41 修正: 使用 3 欄 Grid 佈局實現 Logo 靠左，標題真置中 -->
        <div class="grid grid-cols-3 items-center mb-4 border-b-4 border-kino pb-2 relative">
            <!-- Col 1: Logo 容器 (Flex items-center for vertical alignment) -->
            <div class="flex items-center group cursor-pointer has-no-logo" id="logo-wrapper" title="點擊上傳公司 Logo">
                <img id="logo-img" src="" class="hidden" alt="Logo">
                <div id="logo-placeholder" class="h-10 w-10 bg-gray-100 rounded-full flex items-center justify-center text-gray-300 border-2 border-dashed border-gray-300">
                    <i class="fas fa-image"></i>
                </div>
                <input type="file" id="logo-upload" class="hidden" accept="image/*">
            </div>
            
            <!-- Col 2: H1 報價單標題 (在 Grid Cell 中自動置中) -->
            <h1 class="text-2xl font-extrabold text-gray-900 text-center whitespace-nowrap">
                奇諾影像報價單(Quotation) 
            </h1>

            <!-- Col 3: 佔位 Spacer (保持視覺對稱) -->
            <div></div>
        </div>

        <!-- 報價單資訊 -->
        <div class="header-info-grid grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6 section-block">
            <div class="flex flex-col">
                <div class="header-label">報價單號：</div>
                <input type="text" id="quotation-id" value="" class="quotation-input header-input font-bold text-kino">
            </div>
            
            <div class="flex flex-col">
                <div class="header-label">報價日期：</div>
                <input type="date" id="quotation-date" value="" class="quotation-input header-input">
            </div>

            <div class="flex flex-col">
                <div class="header-label">有效期限：</div>
                <input type="text" id="validity" value="本報價單自發出日起 14 天內有效。" class="quotation-input header-input text-red-600">
            </div>
        </div>

        <!-- 一、 專案內容概況 -->
        <div class="section-block">
            <div class="flex justify-between items-center mt-6 mb-2 border-l-4 border-kino pl-3">
                <h2 class="text-lg font-bold">一、 專案內容概況 (Project Overview)</h2>
                <button id="add-project-item-btn" class="no-print bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs font-bold py-1 px-2 rounded-full transition duration-150">
                    <i class="fas fa-plus mr-1"></i>
                </button>
            </div>
            <div id="project-info-container" class="mb-4 grid grid-cols-2 gap-x-6 gap-y-2 text-sm">
                <!-- Project items injected here -->
            </div>
        </div>

        <!-- 二、 專案報價 -->
        <div class="section-block">
            <div class="flex justify-between items-center mt-6 mb-2 border-l-4 border-kino pl-3">
                <h2 class="text-lg font-bold">二、 專案報價 (Quotation Summary)</h2>
                <button id="add-category-btn" class="no-print bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs font-bold py-1 px-2 rounded-full transition duration-150">
                    <i class="fas fa-plus mr-1"></i> 新增摘要
                </button>
            </div>
            
            <!-- V45: 增加橫向捲動 wrapper -->
            <div class="mb-4 overflow-x-auto">
                <table class="w-full min-w-[600px] text-left text-sm border border-gray-300 rounded-lg overflow-hidden summary-table">
                    <thead class="bg-kino-50">
                        <tr>
                            <th class="font-bold text-gray-700 w-2/3">摘要 (Summary)</th>
                            <th class="text-right font-bold text-gray-700 w-1/3">總計 (NTD)</th>
                            <th class="w-8 no-print"></th>
                        </tr>
                    </thead>
                    <tbody id="summary-tbody" class="text-sm font-medium bg-white">
                        <!-- Dynamic Summary Rows -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 總金額區塊 -->
        <div class="max-w-md ml-auto border border-kino rounded-lg overflow-hidden text-sm summary-block">
            <div class="bg-gray-50 px-2 py-1 text-right border-b border-gray-200 no-print">
                <label class="text-xs font-bold text-gray-500 mr-1">稅額計算：</label>
                <!-- V47: 更新稅額選項 -->
                <select id="tax-mode" class="text-xs border border-gray-300 rounded px-1 py-0 bg-white cursor-pointer hover:border-kino focus:outline-none">
                    <option value="excluded">報價未稅</option>
                    <option value="inclusive_flat">報價含稅</option>
                    <option value="included">稅外 (5%)</option>
                </select>
            </div>

            <div class="grid grid-cols-2 font-medium">
                <div class="bg-gray-100 px-2 py-2 flex items-center">
                    <span>服務項目總計 (∆)</span>
                </div>
                <div id="total-a" class="bg-gray-100 px-2 py-2 text-right font-bold text-gray-800">0</div>

                <div class="bg-kino text-white px-2 py-2 flex flex-col justify-center">
                    <span id="grand-total-label" class="font-bold">本次報價總金額 (含稅)</span>
                    <span id="tax-note" class="text-xs opacity-90 font-normal scale-90 origin-left">(∆ x 1.05)</span>
                </div>
                <div id="grand-total" class="bg-kino text-white px-2 py-2 text-right font-extrabold text-lg flex items-center justify-end">0</div>
            </div>
        </div>
        
        <!-- 三、 客製化專案細節 -->
        <div class="section-block">
            <h2 class="text-lg font-bold mt-6 mb-2 border-l-4 border-kino pl-3">三、 客製化專案細節 (Customization Details)</h2>
            <div class="mt-2">
                <p class="text-[10px] text-gray-500 mb-2 no-print"><i class="fas fa-edit"></i> 點擊下方文字即可編輯。按 <strong>Enter</strong> 新增項目 (自動編號)。</p>
                <ol id="notes-list-editor" contenteditable="true" class="text-sm leading-relaxed p-4 bg-kino-50 rounded-xl border-none focus:ring-0 focus:outline-none min-h-[100px]">
                    <!-- 內容由 JS 初始化 -->
                </ol>
            </div>
        </div>

        <!-- 四、 付款方式 -->
        <div class="section-block payment-section-container">
            <div class="flex justify-between items-center mt-6 mb-2 border-l-4 border-kino pl-3">
                 <h2 class="text-lg font-bold">四、 付款方式與條款 (Payment Methods)</h2>
                 <button id="add-payment-btn" class="no-print bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs font-bold py-1 px-2 rounded-full transition duration-150">
                    <i class="fas fa-plus mr-1"></i>
                </button>
            </div>
            
            <!-- V45: 增加橫向捲動 wrapper -->
            <div class="overflow-x-auto mb-4">
                <table class="min-w-[600px] w-full divide-y divide-gray-200 border border-gray-300 summary-table">
                    <thead class="bg-kino-50">
                        <tr>
                            <th class="text-left text-xs font-medium text-gray-700 uppercase w-[12%]">階段</th>
                            <th class="text-center text-xs font-medium text-gray-700 uppercase w-[10%]">付款比例</th>
                            <th class="text-left text-xs font-medium text-gray-700 uppercase w-[40%]">付款條件</th>
                            <th class="text-left text-xs font-medium text-gray-700 uppercase w-[30%]">備註</th>
                            <th class="text-center text-xs font-medium text-gray-700 uppercase w-[8%] no-print"></th>
                        </tr>
                    </thead>
                    <tbody id="payment-terms-body" class="bg-white divide-y divide-gray-200 text-xs">
                        <!-- Payment terms will be injected here -->
                    </tbody>
                </table>
            </div>

            <!-- 修正：戶名銀行帳號保持在同一列且字級縮小 -->
            <div id="bank-info" class="space-y-0 text-sm pl-3 bg-gray-50 p-2 rounded-lg border border-gray-200 mt-4">
                <h4 class="font-bold border-b pb-1 mb-1 text-red-700">乙方收款資訊：</h4>
                <!-- START: 修正區塊，使用 flex-nowrap 和 flex-1 確保水平佈局 -->
                <div class="bank-info-grid">
                    <div class="flex items-center flex-nowrap min-w-0">
                        戶名：<input type="text" data-key="accountName" value="奇諾影像有限公司" class="quotation-input inline-block flex-1 bg-transparent border-none p-0 h-auto text-xs sm:text-sm">
                    </div>
                    <div class="flex items-center flex-nowrap min-w-0">
                        銀行：<input type="text" data-key="bankName" value="807 永豐銀行 板新分行" class="quotation-input inline-block flex-1 bg-transparent border-none p-0 h-auto text-xs sm:text-sm">
                    </div>
                    <div class="flex items-center flex-nowrap min-w-0">
                        帳號：<input type="text" data-key="accountNumber" value="007-018-0005565-8" class="quotation-input inline-block flex-1 bg-transparent border-none p-0 h-auto text-xs sm:text-sm">
                    </div>
                </div>
                <!-- END: 修正區塊 -->
            </div>
            <p class="mt-2 text-red-700 text-xs font-medium">** 逾期付款：若甲方逾期、未足額支付任何一期款項，乙方有權暫停後續的製作或交付工作，直至款項結清。</p>
        </div>

        <!-- 五、 報價確認與簽署 -->
        <div class="section-block signature-block">
            <h2 class="text-lg font-bold mt-6 mb-2 border-l-4 border-kino pl-3">五、 報價確認與簽署 (Signatures)</h2>
            <!-- V45: 確保 min-w, wrapper 已有 overflow-x-auto -->
            <div class="w-full overflow-x-auto shadow-lg rounded-lg border border-gray-300">
                <table class="min-w-[600px] w-full divide-y divide-gray-200 summary-table">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="text-left text-xs font-bold text-gray-700 uppercase w-1/6">項目</th>
                            <th class="text-center text-xs font-bold text-gray-700 uppercase w-5/12">甲方</th>
                            <th class="text-center text-xs font-bold text-gray-700 uppercase w-5/12">乙方</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200 text-sm text-gray-900">
                        <tr>
                            <td class="font-bold bg-kino-50">抬頭</td>
                            <td>
                                <input type="text" data-key="clientCompany" class="quotation-input text-center text-kino font-semibold">
                            </td>
                            <td>
                                <input type="text" data-key="vendorCompany" value="奇諾影像有限公司" class="quotation-input text-center text-kino font-semibold">
                            </td>
                        </tr>
                        <tr>
                            <td class="font-bold bg-kino-50">代表人</td>
                            <td>
                                <input type="text" data-key="clientContact" class="quotation-input text-center text-kino font-semibold">
                            </td>
                            <td>
                                <input type="text" data-key="vendorContact" value="陳廷安" class="quotation-input text-center text-kino font-semibold">
                            </td>
                        </tr>
                        <tr>
                            <td class="font-bold bg-kino-50">統一編號</td>
                            <td>
                                <input type="text" data-key="clientTaxId" class="quotation-input text-center text-kino font-semibold">
                            </td>
                            <td>
                                <input type="text" data-key="vendorTaxId" value="83115577" class="quotation-input text-center text-kino font-semibold">
                            </td>
                        </tr>
                        <tr>
                            <td class="font-bold bg-kino-50">聯絡電話</td>
                            <td>
                                <input type="text" data-key="clientPhone" class="quotation-input text-center text-kino font-semibold">
                            </td>
                            <td>
                                <input type="text" data-key="vendorPhone" value="0911715138" class="quotation-input text-center text-kino font-semibold">
                            </td>
                        </tr>
                        <tr>
                            <td class="font-bold bg-kino-50">簽署</td>
                            <td class="py-4 text-center relative signature-upload-wrapper" id="client-sig-wrapper">
                                 <div class="signature-area">
                                    <img id="client-sig-img" src="" class="signature-img hidden" alt="甲方簽名">
                                    <div class="border-b border-black w-full h-0.5"></div>
                                 </div>
                                 <div class="upload-hint absolute top-1 right-2 text-[10px] text-gray-400 opacity-0 transition-opacity pointer-events-none no-print">上傳</div>
                                 <input type="file" class="hidden" accept="image/*">
                            </td>
                            <td class="py-4 text-center relative signature-upload-wrapper" id="vendor-sig-wrapper">
                                 <div class="signature-area">
                                    <img id="vendor-sig-img" src="" class="signature-img hidden" alt="乙方簽名">
                                    <div class="border-b border-black w-full h-0.5"></div>
                                 </div>
                                 <div class="upload-hint absolute top-1 right-2 text-[10px] text-gray-400 opacity-0 transition-opacity pointer-events-none no-print">上傳</div>
                                 <input type="file" class="hidden" accept="image/*">
                            </td>
                        </tr>
                        <tr id="signature-date-row">
                            <td class="font-bold bg-kino-50">日期</td>
                            <td colspan="2"><input type="date" data-key="signatureDate" class="quotation-input text-center"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- VI. 服務細項與描述 -->
        <div class="detailed-section border-t border-gray-300">
            <h2 class="text-xl font-bold mb-4 text-gray-800 border-l-8 border-kino pl-4">
                六、 服務細項與描述 (Detailed Services and Description)
            </h2>
            <p class="text-xs text-gray-600 mb-4 no-print">本區塊詳細列出四大項目的所有費用細節，可使用 +/- 按鈕進行增減。</p>
            <div id="quotation-sections"></div>
        </div>

    </div>

    <script>
        // -----------------------------------------------------------
        // 放上 LOGO base64位置
        // -----------------------------------------------------------
        const defaultLogo = "data:image/png;base64,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"; 

        const defaultCategories = [
            { id: 'preProduction', name: 'I. Pre-production Expenses / 前期' },
            { id: 'crew', name: 'II. Production Crew Expenses / 拍攝' },
            { id: 'equipment', name: 'III. Equipment Rental / 器材' },
            { id: 'postProduction', name: 'IV. Video Post Production / 影像後期' }
        ];

        let categories = JSON.parse(JSON.stringify(defaultCategories));

        const defaultItems = {
            preProduction: [
                { desc: "前期企劃與腳本撰寫（含 2 次修改）", qty: 1, unit: "式", price: 0 },
                { desc: "場地租賃或勘景費用", qty: 1, unit: "式", price: 0 },
            ],
            crew: [
                { desc: "導演（含現場指導與後期監製）", qty: 1, unit: "天", price: 0 },
                { desc: "攝影組（影像構圖及視覺呈現）", qty: 1, unit: "天", price: 0 },
                { desc: "燈光組（塑造場景畫面氛圍）", qty: 1, unit: "天", price: 0 },
                { desc: "造型師（包含 3 位演員）", qty: 1, unit: "天", price: 0 },
            ],
            equipment: [
                { desc: "全幅攝影機租賃（Sony FX3 或同級）", qty: 1, unit: "天", price: 0 },
                { desc: "進階燈光組租賃（含柔光、硬光、控光設備）", qty: 1, unit: "天", price: 0 },
                { desc: "高階無線收音設備（24-bit 浮點錄音）", qty: 1, unit: "天", price: 0 },
            ],
            postProduction: [
                { desc: "影片剪輯（含毛片初剪、精剪，2 次修改）", qty: 1, unit: "式", price: 0 },
                { desc: "校色調光（一級校色還原、二級調光）", qty: 1, unit: "式", price: 0 },
                { desc: "視覺特效和字卡（效果字和2D動畫等）", qty: 1, unit: "式", price: 0 },
                { desc: "版權配樂和音效處理（商用授權）", qty: 1, unit: "次", price: 0 },
            ],
        };

        const defaultProjectInfo = [
            { label: "專案名稱", value: "形象影片" },
            { label: "專案類型", value: "影片統籌製作" },
            { label: "片長預估", value: "約2分鐘" },
            { label: "交付格式", value: "Full HD" }
        ];

        const defaultPaymentTerms = [
            { phase: "第一期 (訂金)", percent: "40%", condition: "本報價單/合約簽訂後 3 日內支付。", notes: "專案正式啟動" },
            { phase: "第二期 (拍攝款)", percent: "30%", condition: "影片拍攝日結束後 3 日內支付。", notes: "拍攝團隊費用" },
            { phase: "第三期 (尾款)", percent: "30%", condition: "最終成品 (Final) 交付後 7 日內支付。", notes: "專案結案及剪輯費用" }
        ];
        
        const defaultNotes = `甲方委託乙方於2025年12月1日拍攝形象影片，成品交付影片乙支，拍攝期間甲方應於現場確認畫面無虞，<br>製作費包含乙方 ■ 技術人員、 □ 演員、 □ 場地、 ■ 器材等相關費用，<br>專案期間或結案後，甲方對於本專案內容倘有除合約議定外額外製作/修改需求，為本案預算不可及之部分，<br>經雙方協議後，由乙方針對甲方需求另行報價。

影片經後期輸出後，內容若有須修改事項，甲方得於每次收件 7 日內要求乙方修正，次數 2 次為限。

乙方擔保就其提供甲方利用之影片內容，除由甲方提供或要求外，具有合法智慧財產權利，<br>若有違反著作權之爭議相關法律責任由乙方負責。

乙方應於約定交片日完成本專案並交付予甲方，甲方了解製作時程根據溝通回覆之進度而有不同差異，<br>若因自然災害等不可抗力之因素或甲方要求致無法遵守進度時，雙方應另議交片日或依下列第5條所示結算。

如非乙方之過失而中途停止或取消本案之執行時，其已執行部份仍需計費，<br>非經雙方同意仍應支付全額費用，甲方不得以本案尚未全部完成為理由而拒絕付款。

本契約之解釋、效力及其他未盡事宜，皆以相關法律為準則。倘有任何糾紛，雙方亦應依誠實信用原則解決。<br>如有訴訟必要，雙方同意於新北地方法院板橋簡易庭進行訴訟程序。`;

        const formatter = new Intl.NumberFormat('zh-TW');

        function updateQuotationId() {
            const quotationDateInput = document.getElementById('quotation-date');
            const projectInfoContainer = document.getElementById('project-info-container');
            const quotationIdInput = document.getElementById('quotation-id');

            const dateVal = quotationDateInput.value;
            if (!dateVal) return;
            const [y, m, d] = dateVal.split('-');
            const yymmdd = `${y.slice(2)}${m}${d}`;
            
            let projectName = "專案名稱";
            const projectInputs = projectInfoContainer.querySelectorAll('input[type="text"]');
            for (let i = 0; i < projectInputs.length; i += 2) {
                if (projectInputs[i] && projectInputs[i].value.includes("專案名稱")) {
                    if (projectInputs[i+1]) {
                        projectName = projectInputs[i+1].value || "未命名專案";
                    }
                    break;
                }
            }
            
            const newPrefix = `${yymmdd} ${projectName}`;
            const currentId = quotationIdInput.value;
            let suffix = "_KS01"; 
            const match = currentId.match(/(_KS.+)$/);
            if (match) {
                suffix = match[1];
            }
            quotationIdInput.value = `${newPrefix}${suffix}`;
        }

        function handleImageUpload(input, imgId) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById(imgId);
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                    
                    if (imgId === 'logo-img') {
                        document.getElementById('logo-wrapper').classList.remove('has-no-logo');
                    }
                    saveStateToLocal();
                };
                reader.readAsDataURL(file);
            }
        }

        function saveStateToLocal() {
            try {
                const data = collectQuotationData();
                localStorage.setItem('kino_quotation_draft', JSON.stringify(data));
                const status = document.getElementById('status-message');
                if(status) status.textContent = "系統就緒 (已自動暫存草稿)。";
            } catch(e) { console.log("Auto-save failed", e); }
        }

        function initNotesEditor(content) {
            const editor = document.getElementById('notes-list-editor');
            if (!editor) return;

            if (!content || content.trim() === '') return;

            const points = content.split(/\n/g)
                                .map(p => p.trim())
                                .filter(p => p.length > 0);
            
            let html = '';
            points.forEach(point => {
                html += `<li>${point}</li>`;
            });
            editor.innerHTML = html;
        }

        function getNotesFromEditor() {
            const editor = document.getElementById('notes-list-editor');
            if (!editor) return '';
            
            const lis = editor.querySelectorAll('li');
            const lines = [];
            lis.forEach(li => {
                let text = li.innerHTML;
                text = text.replace(/<br\s*\/?>/gi, '\n');
                lines.push(text.trim());
            });
            return lines.join('\n\n');
        }

        function initQuotationGenerator() {
            try {
                const totalAElement = document.getElementById('total-a');
                const grandTotalElement = document.getElementById('grand-total');
                const grandTotalLabel = document.getElementById('grand-total-label');
                const taxNote = document.getElementById('tax-note');
                const taxModeSelect = document.getElementById('tax-mode');
                
                const saveBtn = document.getElementById('saveBtn');
                const loadBtn = document.getElementById('loadBtn');
                const fileInput = document.getElementById('fileInput');
                
                const projectInfoContainer = document.getElementById('project-info-container');
                const addProjectItemBtn = document.getElementById('add-project-item-btn');
                const quotationIdInput = document.getElementById('quotation-id');
                const quotationDateInput = document.getElementById('quotation-date');

                const printDetailsToggle = document.getElementById('print-details-toggle');
                const printModeScaledToggle = document.getElementById('print-mode-scaled');
                const showSigDateToggle = document.getElementById('show-sig-date-toggle');
                const signatureDateRow = document.getElementById('signature-date-row');
                
                const paymentTermsBody = document.getElementById('payment-terms-body');
                const addPaymentBtn = document.getElementById('add-payment-btn');
                const addCategoryBtn = document.getElementById('add-category-btn'); 

                const clientSigWrapper = document.getElementById('client-sig-wrapper');
                const vendorSigWrapper = document.getElementById('vendor-sig-wrapper');
                const logoWrapper = document.getElementById('logo-wrapper');
                
                const notesEditor = document.getElementById('notes-list-editor');

                
                function createProjectItem(label = "項目名稱", value = "") {
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-2 group relative pr-6';
                    div.innerHTML = `
                        <input type="text" class="font-semibold text-gray-700 bg-transparent border-b border-gray-300 focus:border-kino focus:outline-none w-1/3 text-right px-1" value="${label}" placeholder="標題">
                        <span class="text-gray-500">：</span>
                        <input type="text" class="quotation-input w-2/3" value="${value}" placeholder="內容">
                        <button class="absolute right-0 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity no-print delete-proj-btn" title="刪除此項目">
                            <i class="fas fa-times-circle"></i>
                        </button>
                    `;
                    div.querySelector('.delete-proj-btn').addEventListener('click', () => {
                        div.remove();
                        updateQuotationId();
                        saveStateToLocal();
                    });
                    div.querySelectorAll('input').forEach(input => {
                        input.addEventListener('input', () => {
                            updateQuotationId();
                            saveStateToLocal();
                        });
                    });
                    return div;
                }

                function handleAddProjectItem() {
                    projectInfoContainer.appendChild(createProjectItem("", ""));
                    saveStateToLocal();
                }

                function createPaymentTermRow(term) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-2 py-1 font-bold"><input type="text" data-key="phase" value="${term.phase}" class="quotation-input font-bold"></td>
                        <td class="px-2 py-1 text-center text-kino font-bold"><input type="text" data-key="percent" value="${term.percent}" class="quotation-input text-center text-kino font-bold"></td>
                        <td class="px-2 py-1"><input type="text" data-key="condition" value="${term.condition}" class="quotation-input"></td>
                        <td class="px-2 py-1"><input type="text" data-key="notes" value="${term.notes}" class="quotation-input"></td>
                        <td class="px-2 py-1 text-center no-print">
                            <button class="text-red-500 hover:text-red-700 p-1 rounded-full delete-payment-btn" title="刪除此條款">
                                <i class="fas fa-trash-alt fa-sm"></i>
                            </button>
                        </td>
                    `;
                    row.querySelector('.delete-payment-btn').addEventListener('click', () => {
                        row.remove();
                        saveStateToLocal();
                    });
                    row.querySelectorAll('input').forEach(i => i.addEventListener('input', saveStateToLocal));
                    return row;
                }

                function handleAddPaymentTerm() {
                    paymentTermsBody.appendChild(createPaymentTermRow({ phase: "第X期", percent: "XX%", condition: "", notes: "" }));
                    saveStateToLocal();
                }

                function renderCategories() {
                    const summaryTbody = document.getElementById('summary-tbody');
                    const detailedContainer = document.getElementById('quotation-sections');
                    
                    const existingData = {};
                    categories.forEach(cat => {
                        const tbody = document.querySelector(`[data-tbody-key="${cat.id}"]`);
                        if (tbody) {
                            existingData[cat.id] = Array.from(tbody.querySelectorAll('tr')).map(row => ({
                                desc: row.querySelector('input[data-key="desc"]').value,
                                qty: row.querySelector('input[data-key="qty"]').value,
                                unit: row.querySelector('input[data-key="unit"]').value,
                                price: row.querySelector('input[data-key="price"]').value
                            }));
                        }
                    });

                    summaryTbody.innerHTML = '';
                    detailedContainer.innerHTML = '';

                    categories.forEach((cat, index) => {
                        const sumRow = document.createElement('tr');
                        sumRow.className = "hover:bg-gray-50 transition";
                        sumRow.innerHTML = `
                            <td>
                                <input type="text" class="w-full bg-transparent font-bold text-gray-700 focus:outline-none" value="${cat.name}" oninput="updateCategoryName('${cat.id}', this.value)">
                            </td>
                            <td id="summary-${cat.id}" class="text-right text-gray-800">0</td>
                            <td class="no-print text-center">
                                <button class="text-red-400 hover:text-red-600 delete-cat-btn" onclick="deleteCategory('${cat.id}')">
                                    <i class="fas fa-minus-circle"></i>
                                </button>
                            </td>
                        `;
                        summaryTbody.appendChild(sumRow);

                        // V39 修正 (b): 第六項標題底色配色
                        const isDark = index % 2 === 0;
                        const headerClass = isDark ? 'bg-kino-darker text-white' : 'bg-kino-medium text-white';
                        const btnClass = isDark ? 'bg-white text-kino-darker hover:bg-gray-100' : 'bg-white text-kino-medium hover:bg-gray-100';

                        // V45 修正: 加入 overflow-x-auto 容器與表格 min-w-[600px]
                        const sectionHtml = `
                        <div data-section-key="${cat.id}" class="mb-6 border border-gray-300 rounded-lg overflow-hidden shadow-md">
                            <div class="flex justify-between items-center ${headerClass} p-3">
                                <h3 class="font-bold" id="title-${cat.id}">${cat.name}</h3>
                                <button class="add-item-btn no-print ${btnClass} text-xs font-bold py-1 px-3 rounded-full transition duration-150" data-section="${cat.id}">
                                    <i class="fas fa-plus mr-1"></i> 新增項目
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="item-table text-sm min-w-[600px]">
                                    <thead>
                                        <tr class="bg-gray-100">
                                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase w-5/12">細項（Item）</th>
                                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-700 uppercase w-1/12">數量</th>
                                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-700 uppercase w-1/12">單位</th>
                                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-700 uppercase w-2/12">單價 (NTD)</th>
                                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-700 uppercase w-2/12">小計 (NTD)</th>
                                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-700 uppercase w-1/12 no-print">動作</th>
                                        </tr>
                                    </thead>
                                    <tbody data-tbody-key="${cat.id}"></tbody>
                                </table>
                            </div>
                            <div class="text-right p-3 bg-gray-50 font-bold text-base border-t border-gray-300">
                                總計：<span data-subtotal-key="${cat.id}">0</span> NTD
                            </div>
                        </div>`;
                        detailedContainer.insertAdjacentHTML('beforeend', sectionHtml);
                        
                        const tbody = document.querySelector(`[data-tbody-key="${cat.id}"]`);
                        let items = existingData[cat.id];
                        if (!items) {
                             items = defaultItems[cat.id] || [];
                        }
                        
                        items.forEach(item => {
                            const p = typeof item.price === 'string' ? parseFloat(item.price.replace(/,/g, '')) : item.price;
                            tbody.appendChild(createLineItem({
                                desc: item.desc,
                                qty: item.qty,
                                unit: item.unit,
                                price: p
                            }, cat.id));
                        });
                    });
                    
                    recalculateTotals();
                }

                window.updateCategoryName = function(id, newName) {
                    const cat = categories.find(c => c.id === id);
                    if (cat) {
                        cat.name = newName;
                        const titleEl = document.getElementById(`title-${id}`);
                        if (titleEl) titleEl.textContent = newName;
                        saveStateToLocal();
                    }
                };

                window.deleteCategory = function(id) {
                    if (confirm('確定要刪除此摘要及其所有細項嗎？')) {
                        categories = categories.filter(c => c.id !== id);
                        renderCategories();
                        saveStateToLocal();
                    }
                };

                addCategoryBtn.addEventListener('click', () => {
                    const id = 'cat_' + Date.now();
                    categories.push({ id: id, name: '新摘要項目' });
                    renderCategories();
                    saveStateToLocal();
                });

                function createLineItem(item, sectionKey) {
                    const row = document.createElement('tr');
                    row.dataset.section = sectionKey;
                    row.innerHTML = `
                        <td class="px-3 py-2 font-medium text-gray-900">
                            <input type="text" data-key="desc" value="${item.desc}" class="quotation-input w-full">
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap text-center">
                            <input type="number" data-key="qty" value="${item.qty}" min="0" class="quotation-input qty-input text-center">
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap text-center text-gray-500">
                            <input type="text" data-key="unit" value="${item.unit}" class="quotation-input text-center w-12">
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap text-right">
                            <input type="text" data-key="price" value="${formatter.format(item.price)}" class="quotation-input price-input text-right" 
                                onfocus="this.value = this.value.replace(/,/g, '')" 
                                onblur="this.value = formatter.format(parseFloat(this.value.replace(/,/g, '')) || 0); recalculateTotals();">
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap text-right font-bold text-kino subtotal-cell">
                            ${formatter.format(item.qty * item.price)}
                        </td>
                        <td class="px-3 py-2 text-center no-print">
                            <button class="delete-item-btn text-red-500 hover:text-red-700 p-1 rounded-full transition duration-150">
                                <i class="fas fa-trash-alt fa-sm"></i>
                            </button>
                        </td>
                    `;
                    row.querySelector('.delete-item-btn').addEventListener('click', (e) => {
                        e.preventDefault();
                        row.remove();
                        recalculateTotals();
                        saveStateToLocal();
                    });
                    row.querySelectorAll('.qty-input, .price-input, [data-key="unit"]').forEach(input => {
                        input.addEventListener('input', () => {
                            recalculateTotals();
                            saveStateToLocal();
                        });
                    });
                    return row;
                }

                function handleAddItem(event) {
                    const btn = event.target.closest('.add-item-btn');
                    if(!btn) return;
                    const sectionKey = btn.dataset.section;
                    const tbody = document.querySelector(`[data-tbody-key="${sectionKey}"]`);
                    if (tbody) {
                        const newItem = { desc: "[新項目描述]", qty: 1, unit: "式", price: 0 };
                        const newRow = createLineItem(newItem, sectionKey);
                        tbody.appendChild(newRow);
                        recalculateTotals();
                        newRow.querySelector('input[data-key="desc"]').focus();
                        saveStateToLocal();
                    }
                }

                function recalculateTotals() {
                    let totalA = 0;
                    categories.forEach(cat => {
                        let sectionTotal = 0;
                        const tbody = document.querySelector(`[data-tbody-key="${cat.id}"]`);
                        if (!tbody) return;

                        const lineItems = tbody.querySelectorAll('tr');
                        lineItems.forEach((row) => {
                            const qtyInput = row.querySelector('.qty-input');
                            const priceInput = row.querySelector('.price-input');
                            
                            const qty = parseInt(qtyInput.value) || 0;
                            const price = parseFloat(priceInput.value.replace(/,/g, '')) || 0; 
                            const subtotal = qty * price;
                            sectionTotal += subtotal;
                            
                            const subtotalCell = row.querySelector('.subtotal-cell');
                            if(subtotalCell) subtotalCell.textContent = formatter.format(subtotal);
                        });

                        const subtotalDisplay = document.querySelector(`[data-subtotal-key="${cat.id}"]`);
                        if(subtotalDisplay) subtotalDisplay.textContent = formatter.format(sectionTotal);
                        
                        const summaryEl = document.getElementById(`summary-${cat.id}`);
                        if (summaryEl) {
                            summaryEl.textContent = formatter.format(sectionTotal);
                        }
                        totalA += sectionTotal;
                    });

                    const taxMode = taxModeSelect.value;
                    let grandTotal = 0;
                    // V47: 稅額計算邏輯更新
                    if (taxMode === 'included') {
                        // 稅外 (5%) - 原含稅(5%)邏輯
                        grandTotal = Math.round(totalA * 1.05);
                        grandTotalLabel.textContent = "本次報價總金額 (含稅)";
                        taxNote.textContent = "(∆ x 1.05)";
                        taxNote.style.display = 'inline';
                    } else if (taxMode === 'inclusive_flat') {
                        // 報價含稅 - 金額同未稅，顯示(含稅)
                        grandTotal = totalA;
                        grandTotalLabel.textContent = "本次報價總金額 (含稅)";
                        taxNote.textContent = "";
                        taxNote.style.display = 'none';
                    } else {
                        // 報價未稅 - 原未稅邏輯
                        grandTotal = totalA;
                        grandTotalLabel.textContent = "本次報價總金額 (未稅)";
                        taxNote.textContent = "";
                        taxNote.style.display = 'none';
                    }

                    totalAElement.textContent = formatter.format(totalA);
                    grandTotalElement.textContent = formatter.format(grandTotal);
                }

                function collectQuotationData() {
                    const items = {};
                    categories.forEach(cat => {
                        const tbody = document.querySelector(`[data-tbody-key="${cat.id}"]`);
                        if (!tbody) return;
                        items[cat.id] = Array.from(tbody.querySelectorAll('tr')).map(row => {
                            const desc = row.querySelector('input[data-key="desc"]').value;
                            const qty = parseInt(row.querySelector('input[data-key="qty"]').value) || 0;
                            const unit = row.querySelector('input[data-key="unit"]').value;
                            const price = parseFloat(row.querySelector('input[data-key="price"]').value.replace(/,/g, '')) || 0; 
                            return { desc, qty, unit, price };
                        });
                    });

                    const projectInfo = [];
                    projectInfoContainer.querySelectorAll('div.flex').forEach(div => {
                        const inputs = div.querySelectorAll('input');
                        if(inputs.length >= 2) {
                            projectInfo.push({ label: inputs[0].value, value: inputs[1].value });
                        }
                    });

                    const paymentTerms = Array.from(paymentTermsBody.querySelectorAll('tr')).map(row => ({
                        phase: row.querySelector('input[data-key="phase"]').value,
                        percent: row.querySelector('input[data-key="percent"]').value,
                        condition: row.querySelector('input[data-key="condition"]').value,
                        notes: row.querySelector('input[data-key="notes"]').value,
                    }));

                    // V46 Fix: Using stable class selector
                    const signatureInputs = document.querySelector('.signature-block table tbody');
                    const signatureData = Array.from(signatureInputs.querySelectorAll('input:not([type="file"])')).reduce((acc, input) => {
                        if(input.dataset.key) acc[input.dataset.key] = input.value;
                        return acc;
                    }, {});
                    
                    const clientSigImg = document.getElementById('client-sig-img');
                    const vendorSigImg = document.getElementById('vendor-sig-img');
                    if (!clientSigImg.classList.contains('hidden')) signatureData.clientSigImg = clientSigImg.src;
                    if (!vendorSigImg.classList.contains('hidden')) signatureData.vendorSigImg = vendorSigImg.src;

                    let logoData = "";
                    const logoImg = document.getElementById('logo-img');
                    if(!logoImg.classList.contains('hidden')) {
                        logoData = logoImg.src;
                    }

                    const bankInfo = Array.from(document.getElementById('bank-info').querySelectorAll('input')).reduce((acc, input) => {
                            acc[input.dataset.key] = input.value;
                            return acc;
                        }, {});

                    const data = {
                        header: {
                            quotationId: quotationIdInput.value,
                            quotationDate: quotationDateInput.value,
                            validity: document.getElementById('validity').value,
                        },
                        project: projectInfo,
                        taxMode: taxModeSelect.value,
                        categories: categories, 
                        items: items,
                        notes: getNotesFromEditor(),
                        payment: { terms: paymentTerms },
                        signature: signatureData,
                        logo: logoData,
                        bank: bankInfo,
                        timestamp: new Date().toISOString(),
                        // 保存新的列印設定
                        printSettings: {
                            scaledMode: printModeScaledToggle.checked,
                            showPageNumbers: false, 
                        }
                    };
                    return data;
                }

                function populateForm(data) {
                    if (!data) return;
                    
                    quotationIdInput.value = data.header?.quotationId || "";
                    // E. 即使讀取舊檔，若您希望載入後日期也是今天，可在此覆蓋。
                    // 但通常「載入舊檔」應保留舊檔日期。
                    // 「開啟程式時」則預設今天。這段是 populateForm，主要用於載入。
                    if (data.header?.quotationDate) {
                        quotationDateInput.value = data.header.quotationDate;
                    }

                    document.getElementById('validity').value = data.header?.validity || '本報價單自發出日起 14 天內有效。';
                    
                    if (data.taxMode) taxModeSelect.value = data.taxMode;

                    // 載入列印設定
                    if (data.printSettings) {
                        printModeScaledToggle.checked = data.printSettings.scaledMode || false;
                        
                        // 立即應用樣式
                        if (printModeScaledToggle.checked) {
                            document.body.classList.add('print-scaled');
                        }
                    } 


                    projectInfoContainer.innerHTML = '';
                    let projectData = Array.isArray(data.project) ? data.project : defaultProjectInfo;
                    projectData.forEach(item => {
                        projectInfoContainer.appendChild(createProjectItem(item.label, item.value));
                    });
                    
                    // 如果沒有單號，更新一下
                    if (!data.header?.quotationId) {
                         updateQuotationId();
                    }

                    initNotesEditor(data.notes || defaultNotes);

                    const bankInputs = document.getElementById('bank-info').querySelectorAll('input');
                    bankInputs.forEach(input => {
                        if (data.bank && data.bank[input.dataset.key] !== undefined) input.value = data.bank[input.dataset.key];
                    });
                    
                    paymentTermsBody.innerHTML = '';
                    const termsToLoad = (data.payment && Array.isArray(data.payment.terms) && data.payment.terms.length > 0)
                                        ? data.payment.terms 
                                        : defaultPaymentTerms;
                    termsToLoad.forEach(term => {
                        paymentTermsBody.appendChild(createPaymentTermRow(term));
                    });

                    // V46 Fix: Using stable class selector
                    const signatureInputs = document.querySelector('.signature-block table tbody').querySelectorAll('input:not([type="file"])');
                    signatureInputs.forEach(input => {
                        if (data.signature && data.signature[input.dataset.key] !== undefined) {
                            input.value = data.signature[input.dataset.key];
                        }
                    });
                    if (data.signature?.clientSigImg) {
                        const img = document.getElementById('client-sig-img');
                        img.src = data.signature.clientSigImg;
                        img.classList.remove('hidden');
                    }
                    if (data.signature?.vendorSigImg) {
                        const img = document.getElementById('vendor-sig-img');
                        img.src = data.signature.vendorSigImg;
                        img.classList.remove('hidden');
                    }
                    
                    if (data.logo) {
                        const img = document.getElementById('logo-img');
                        img.src = data.logo;
                        img.classList.remove('hidden');
                        document.getElementById('logo-wrapper').classList.remove('has-no-logo');
                    } else if (typeof defaultLogo !== 'undefined' && defaultLogo.length > 30) {
                        const img = document.getElementById('logo-img');
                        img.src = defaultLogo;
                        img.classList.remove('hidden');
                        document.getElementById('logo-wrapper').classList.remove('has-no-logo');
                    }

                    if (data.categories) {
                        categories = data.categories;
                    } else {
                        // V43 清理: defaultCategories 不再包含 color
                        categories = defaultCategories.map(cat => ({ ...cat })); 
                    }
                    
                    renderCategories();
                    
                    categories.forEach(cat => {
                        const tbody = document.querySelector(`[data-tbody-key="${cat.id}"]`);
                        if (tbody) {
                            tbody.innerHTML = '';
                            let itemsToLoad = [];
                            if (data.items && data.items[cat.id]) {
                                itemsToLoad = data.items[cat.id];
                            } else if (!data.items && defaultItems[cat.id]) {
                                itemsToLoad = defaultItems[cat.id];
                            }
                            
                            itemsToLoad.forEach(item => {
                                const p = typeof item.price === 'string' ? parseFloat(item.price.replace(/,/g, '')) : item.price;
                                tbody.appendChild(createLineItem({
                                    desc: item.desc,
                                    qty: item.qty,
                                    unit: item.unit,
                                    price: p
                                }, cat.id));
                            });
                        }
                    });
                   
                    recalculateTotals(); 
                }

                // D. 支援選擇存檔位置 (Chrome/Edge/Desktop)
                async function saveQuotation() {
                    try {
                        updateQuotationId();
                        const data = collectQuotationData();
                        const qId = data.header.quotationId;
                        const fileName = `${qId}.json`;
                        const jsonStr = JSON.stringify(data, null, 2);
                        
                        // 嘗試使用 File System Access API
                        if (window.showSaveFilePicker) {
                            try {
                                const handle = await window.showSaveFilePicker({
                                    suggestedName: fileName,
                                    types: [{
                                        description: 'JSON File',
                                        accept: {'application/json': ['.json']},
                                    }],
                                });
                                const writable = await handle.createWritable();
                                await writable.write(jsonStr);
                                await writable.close();
                                document.getElementById('status-message').textContent = `✅ 檔案儲存成功！`;
                                return;
                            } catch (err) {
                                // 若使用者取消，不動作；若不支援或錯誤，則往下執行舊版下載
                                if (err.name === 'AbortError') return;
                                console.log("File System API failed, fallback to download.", err);
                            }
                        }

                        // 舊版下載方式
                        const blob = new Blob([jsonStr], { type: "application/json" });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = fileName;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        document.getElementById('status-message').textContent = `✅ 檔案 ${fileName} 已下載！`;
                    } catch (error) {
                        console.error("Error saving file: ", error);
                        document.getElementById('status-message').textContent = `❌ 下載失敗: ${error.message}`;
                    }
                }

                // E. 開啟時，日期自動更新為今天 (改用本地時間，避免時區誤差)
                const d = new Date();
                const today = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                
                document.getElementById('quotation-date').value = today;
                document.querySelector('input[data-key="signatureDate"]').value = today;

                const saved = localStorage.getItem('kino_quotation_draft');
                if (saved) {
                    populateForm(JSON.parse(saved));
                    
                    // 若是讀取暫存檔，通常希望日期也是今天(視為繼續編輯)，所以再次強制更新日期與ID前綴
                    document.getElementById('quotation-date').value = today;
                    updateQuotationId(); // 更新單號的前綴部分，保留後綴

                    document.getElementById('status-message').textContent = "已恢復未完成草稿 (v47 - 稅額計算模式更新)。";
                } else {
                    populateForm({ 
                        project: defaultProjectInfo,
                        payment: { terms: defaultPaymentTerms },
                        notes: defaultNotes
                    });
                    updateQuotationId();
                }

                
                quotationDateInput.addEventListener('change', () => {
                    updateQuotationId();
                    saveStateToLocal();
                });
                
                notesEditor.addEventListener('input', () => {
                    saveStateToLocal();
                });

                document.querySelectorAll('input, textarea').forEach(el => {
                    if (el.id !== 'notes-textarea') {
                        el.addEventListener('input', saveStateToLocal);
                    }
                });

                saveBtn.addEventListener('click', saveQuotation);
                loadBtn.addEventListener('click', () => { fileInput.click(); });
                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            populateForm(data);
                            document.getElementById('status-message').textContent = `✅ 檔案 ${file.name} 載入成功！`;
                            fileInput.value = '';
                            saveStateToLocal();
                        } catch (error) {
                            console.error(error);
                            document.getElementById('status-message').textContent = `❌ 檔案解析失敗：${error.message}`;
                        }
                    };
                    reader.readAsText(file);
                });

                addProjectItemBtn.addEventListener('click', handleAddProjectItem);
                addPaymentBtn.addEventListener('click', handleAddPaymentTerm); 
                taxModeSelect.addEventListener('change', () => {
                    recalculateTotals();
                    saveStateToLocal();
                });

                document.getElementById('quotation-sections').addEventListener('click', function(e) {
                    if (e.target.closest('.add-item-btn')) {
                       handleAddItem(e);
                    }
                });
                document.getElementById('quotation-sections').addEventListener('input', (event) => {
                    if (event.target.classList.contains('qty-input') || event.target.classList.contains('price-input')) {
                        if (!event.target.classList.contains('price-input')) {
                            recalculateTotals();
                        }
                    }
                });

                document.getElementById('printBtn').addEventListener('click', () => {
                    window.print();
                });

                printDetailsToggle.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        document.body.classList.remove('print-hide-details');
                    } else {
                        document.body.classList.add('print-hide-details');
                    }
                    saveStateToLocal();
                });
                
                // 單頁列印模式開關
                printModeScaledToggle.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        document.body.classList.add('print-scaled');
                    } else {
                        document.body.classList.remove('print-scaled');
                    }
                    saveStateToLocal();
                });


                showSigDateToggle.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        signatureDateRow.classList.remove('hide-date-row');
                    } else {
                        signatureDateRow.classList.add('hide-date-row');
                    }
                    saveStateToLocal();
                });
                
                clientSigWrapper.addEventListener('click', () => {
                    clientSigWrapper.querySelector('input[type="file"]').click();
                });
                clientSigWrapper.querySelector('input[type="file"]').addEventListener('change', function() {
                    handleImageUpload(this, 'client-sig-img');
                });

                vendorSigWrapper.addEventListener('click', () => {
                    vendorSigWrapper.querySelector('input[type="file"]').click();
                });
                vendorSigWrapper.querySelector('input[type="file"]').addEventListener('change', function() {
                    handleImageUpload(this, 'vendor-sig-img');
                });
                
                logoWrapper.addEventListener('click', () => {
                    logoWrapper.querySelector('input[type="file"]').click();
                });
                logoWrapper.querySelector('input[type="file"]').addEventListener('change', function() {
                    handleImageUpload(this, 'logo-img');
                });
                
            } catch (err) {
                console.error("Initialization Error:", err);
                document.getElementById('status-message').textContent = "⚠️ 程式初始化發生錯誤，請檢查控制台。";
            }
        }

        window.onload = initQuotationGenerator;
    </script>
</body>
</html>
